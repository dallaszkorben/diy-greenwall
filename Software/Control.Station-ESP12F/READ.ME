The code does not work using Micropython.
It always fails somewhere.
So I changed to code to C instead