<meta charset="UTF-8" comntent="text/html;charset=utf-8" http-equiv="Content-Type">

<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1">

<html>
<head>

    <title>Green Wall</title>

    <style>

        /* camCapture in row */
        * {
            box-sizing: border-box;
        }

        .row {
            display: flex;
        }

        /* Create three equal columns that sits next to each other */
        .column {
            padding: 5px;
        }

        /* General fonts */
        * {
            font-size: 18px;
        }

        h1 {
            font-size: 40px;
        }

        #dateFilter {
            margin-left: auto;
            margin-right: auto;
        }

        #errormessage {
            color: red;
            font-weight: bold;
        }

        #labelstationid {
            white-space: nowrap;
            font-size: 18pt;
            font-weight: bold;
            -moz-transform: rotate(-90deg);
            -moz-transform-origin: center center;
            -webkit-transform: rotate(-90deg);
            -webkit-transform-origin: center center;
            -ms-transform: rotate(-90deg);
            -ms-transform-origin: center center;
            max-width: 2em;
            display: inline-block;
        }

        button{
            height: 60px;
            vertical-align: top;
        }

        .chart-canvas{
            min-height:auto;
            width: 100%;
            background-color: rgb(152, 251, 152);
            padding: 0px;
            border: 1px solid;
        }

        /* CAM title aligned to center */
        .cam-img-title {
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size:1.5em;
        }

        /* CHART title aligned to center */
        .chart-img-title {
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size:1.5em;
        }

        /* CAM containder for tables to be flex  */
        .flex-cam-container {
            display: flex;
            flex-wrap: wrap;
            ppadding: 5px;
            justify-content: flex-start;
        }

        /* CHART containder for tables to be flex  */
        .flex-chart-container {
            display: flex;
            flex-wrap: wrap;
            padding: 5px;
            justify-content: flex-start;
        }

        /* 3 pictures per line on normal screen with adaptive size */
        .flex-cam-item {
            mmargin: 5px;
            width: 33.3%;
        }

        /* 3 charts per line on normal screen with adaptive size */
        .flex-chart-item {
            mmargin: 5px;
            padding: 2px;
            width: 33.3%;
        }

        /* 1 picture/chart per line on vertical mobile with adaptive size */
        @media (max-width: 600px) {
            .flex-cam-item {
                float: none;
                width: 100%;
            }
        }

        /* 1 picture/chart per line on vertical mobile with adaptive size */
        @media (max-width: 900px) {
            .flex-chart-item {
                float: none;
                width: 100%;
            }
        }

    </style>

    <!-- Chart -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.8.0/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/1.30.1/date_fns.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <!-- JQuery -->
    <script src="script/jquery/jquery-3.6.0.min.js"></script>
    <script src="script/jquery-ui/jquery-ui.min.js"></script>

    <link href="script/jquery-ui/jquery-ui.css" rel="stylesheet">
    <link href="script/roundedbutton/css/style.css" rel="stylesheet" />

    <script src="script/easy-pie-chart/dist/jquery.easypiechart.min.js"></script>

    <!-- Switch -->
    <script src="script/switch/lc_switch.js"></script>

    <!-- moment -->
    <script src="script/moment/moment.js"></script>

    <!-- favicon -->
    <link rel="shortcut icon" href="favicon.ico">

    <script>

        var levelData = [];
        var temperatureData = [];
        var humidityData = [];
        var pressureData = [];

        var camCaptureList = [];

        var chartRefreshIntervalId = null;
        var camCaptureRefreshIntervalId = null;
        var checkLampStatusRefreshIntervalId = null;
        var checkPumpStatusRefreshIntervalId = null;

        var levelChart = null;
        var temperatureChart = null;
        var humidityChart = null;
        var pressureChart = null;

        var triggerReportBeforeSent = false;

        // {"192.168.50.132": {"name": "lamp1", "id": "id-192.168.50.132", }, }
        var lampDict = {}
        var pumpDict = {}

        var pumpChart;

        var intervalCheckLamp = 10000;
        var intervalCheckPump = 10000;
        var intervalCheckCam = 10000;
        var intervalCheckChart = 600000;  

        $( function() {
            $( "#tabs" ).tabs();
        } );

        function isEmpty(str) {
            return (!str || str.length === 0 );
        }


        function convIp(ip){
            return ip.replaceAll('.','-') 
        }


        // =============================
        //
        // Construct Cam Capture Section
        //
        // =============================
        function constructCamCaptureSection(){

            $.ajax({type: "GET", url: "/cam/captureList", async: true,
                success: function(result){

                    res = result.result

                    if(res == "OK"){

                        newCamCaptureList = [];
                        $.map(result.camCaptureList, function(camCapture){

                            camId = camCapture.camId;
                            camCaptureUrl = camCapture.captureUrl;

                            cc = {};
                            cc['camId'] = camId;
                            cc['camCaptureUrl'] = camCaptureUrl;
                            newCamCaptureList.push(cc);
                        });

                        newCamCaptureList.sort(function(a, b){return a.camId > b.camId});

                        //If the old and new list is the same, does not need to re-build the camCaptureDiv
                        if( newCamCaptureList.length === camCaptureList.length && newCamCaptureList.every(function(value, index) { return value.camId === camCaptureList[index].camId }) ){
                            return;
                        }

                        divCam = $('<div id="camCaptureDiv" class="flex-cam-container">');

                        camCaptureList = newCamCaptureList;
                        $.map(camCaptureList, function(camCapture){

                            camId = camCapture.camId;
                            camCaptureUrl = camCapture.captureUrl;

                            //
                            // TITLE
                            //
                            title=$('<div class="cam-img-title" style="font-size:1.5em">');
                            title.html(camId);

                            //
                            // IMG
                            //
                            var img = $('<img id="cam_' + camId + '">');

                            // Random value after the image name helps to ignore the cache at refresh
                            img.attr('src', '/greenwall/cam-capture/capture_' + camId + '.jpg?' + Math.random());
                            img.attr('style', 'width: 100%;')

                            //
                            // Build up the Table
                            //
                            var tableBody = $("<tbody>");

                            row = $('<tr>');
                            rowData = $('<td style="padding:0px">');
                            row.append(rowData);
                            rowData = rowData.append(title);
                            row.append(rowData);
                            tableBody.append(row);

                            row = $('<tr>');
                            rowData = $('<td style="padding:0px">');
                            row.append(rowData);
                            rowData = rowData.append(img);
                            row.append(rowData);
                            tableBody.append(row);

                            camTable = $('<table class="flex-cam-item" border="0"></table>');
                            camTable.append(tableBody);
                            divCam.append(camTable);

                        });

                        $('#tabs-cam').html("");
                        $('#tabs-cam').append(divCam);

                        //
                        // Add click event listner to all pictures
                        //
                        $.map(camCaptureList, function(camCapture){

                            camId = camCapture.camId;
                            $("#cam_" + camId).on("click", function(e){

                                // Open window - parameter is the camId
                                // I can not put here simple the camId because it always will be the latest selected value
                                // So I just substring it from the <img id>
                                // The click will be executed on <img> so the 'this' value will refer to the <img>
                                // In the function I will substring the camId value from the parameter
                                openCaptureWindow(this.id);

                            });
                        });

                    }else{
                        //$("#value").html("");
                        //$("#errormessage").html("something went wrong");
                        //$("#spinner").hide();
                    }

//                    $("#errormessage").html("");
                },
                error: function(xhr,status,error){
//                    $("#value").html("");
//                    $("#errormessage").html(xhr.statusText + " " + xhr.responseText);
//                    $("#spinner").hide();
                }
            });
        }


        // =========================================================================================================================
        //
        // Open Capture Window
        //
        // That part is pretty tricky
        // The imgId is the <img id> of the capture image which looks like this: cam_4
        // So I have to substring it to get the camId
        //
        // Then I have to provide this camId to the new window, which I will open
        // I provide it through the window name
        // Solving this problem I tried to dynamically construct that page here and put it into the opened page when it is loaded
        // Unfortunatelly this event listener does not work for Chrome. It worked for Firefox though.
        //
        // Plus I had to solve the problem to NOT to open the already opened cam's window, BUT still have to select it
        //
        // ========================================================================================================================

        function openCaptureWindow(imgId){
            var camId = imgId.substring(4);
            var url = 'capture.html';

            // Here I pass the camId as parameter to the new window
            window.prePopObj = camId;
            var newWindow = window.open('', camId, '');
            if(newWindow.location.href === 'about:blank'){
                newWindow.location.href = url;
            }else{
                newWindow.focus();
            }
        }

        // ================================================
        //
        // Refresh Cam Capture
        //
        // ================================================
        function refreshCamCapture(){
            constructCamCaptureSection();

            $.map(camCaptureList, function(camCapture){

                camId = camCapture.camId;
                //camCaptureUrl = camCapture.captureUrl;

                // Random value after the image name helps to ignore the cache at refresh
                $("#cam_" + camId).attr('src', '/greenwall/cam-capture/capture_' + camId + '.jpg?' + Math.random());
            });
        }

        // ================================================
        //
        // Construct a Chart Canvas
        //
        // ================================================
        function constructChartCanvas(chartCanvasId, title, labelY){
            var myChart = new Chart($("#" + chartCanvasId), {

                type: 'scatter',
                data: {
                    datasets: [
                    ]
                },
                options: {
                    onClick: function (evt, i) {openChartWindow(myChart, evt, i)},
                    aspectRatio:1.5,
                    plugins:{
                        title: {
                            display: true,
                            text: title
                        },
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true
                            }
                        },
                    },
                    responsive: true,
                    scales: {
                        x: {
                            grid: {
                                borderWidth: 2,
                                borderColor: '#000000',
                            },

                            type: 'time',
                            //distribution: 'series',
                            time: {
                                //unitStepSize: 10,
                                //parser: 'yy.MM.dd',
                                unit: 'day',
                                tooltipFormat: 'yyyy.MM.dd HH:mmzzz',
                                displayFormats: {
                                    'hour': 'HH:mmzzz',
                                    'day': 'yyyy.MM.dd',
                                    'week': 'yyyy.MM.dd',
                                    'month': 'yyyy.MM',
                                    'quarter': 'yyyy.MM',
                                    'year': 'yyyy',
                                },
                            },
                            title: {
                                display: false,
                                text: 'Date',
                            },
                            ticks: {

                                // Bold on Sunday
                                font:{
                                    weight: (c) => {
                                        day = new Date(c.tick.value).getDay()
                                        return day == 0 ? 'bold' : 'normal';
                                    }
                                },

                                display: true,
                                minRotation: 20,
                                align: 'center',

                                    //major: {
                                    //   font: 'bold',
                                    //   enabled: false,
                                    //   unit: 'day',
                                    //   fontColor: 'red',
                                    //   unitStepSize: 2,
                                    //   displayFormats: {
                                    //      'day': 'yyyy.MM.dd',
                                    //      'hour': 'yyyy'
                                    //   },
                                    //},

                                // Red color on Sunday
                                color: (c) => {
                                    day = new Date(c.tick.value).getDay()
                                    return day == 0 ? 'red' : 'black';
                                }

                                //callback: function(value, index, ticks) {
                                //   ticks.forEach(t => {
                                //      const day = new Date(t.value).getDay();
                                //      t.major = (day == 0 || day == 6);
                                //   });
                                //   return '$' + value;
                                //}

                            },
                        },
                        y: {
                            grid: {
                                borderWidth: 2,
                                borderColor: '#000000',
                                display: true,
                            },

                            beginAtZero: true,
                            display: true,
                            ticks: {
                                display: true,
                                //stepSize: 10,
                            },
                            title: {
                                display: true,
                                text: labelY
                            },
                        }
                    },
                }
            });
            return myChart;
        }

        // ================================================
        //
        // Refresh Charts
        //
        // ================================================
        function refreshCharts(){

            $("#spinner").show();

            // Fetch the date values from the fields
            startDate = $('#startDatePicker').val();
            endDate = $('#endDatePicker').val();

            if (!isEmpty(endDate)){
                // Add 1 more day construct midnight of endDate
                var date = new Date(endDate);
                date.setDate(date.getDate() + 1)

                endYear = date.getFullYear()
                endMonth = date.getMonth() + 1
                endDay = date.getDate()
            }

            param = "startDate/" + startDate + ( isEmpty(endDate) ? "" : ("/endDate/" + endYear + "-" + endMonth + "-" + endDay))

            $("#errormessage").html("");

            $.ajax({type: "GET", url: "/sensor/data/list/" + param, async: true,
                success: function(result){

                    $("#spinner").hide();

                    //result = 
                    //{
                    //    'result': 'OK', 
                    //    'data':
                    //        [
                    //            "S5":
                    //                {
                    //                    "ip":"192.168.0.117", 
                    //                    "record": 
                    //                        [
                    //                            {"timestamp": 35729, "levelValue": 27.3, "temperatureValue": 20.1, "humidityValue": 30, "pressureValue": 103234.45}, 
                    //                            {"timestamp": 35871, "levelValue": 27.1, "temperatureValue": 20.7, "humidityValue": 35, "pressureValue": 103453.62}, 
                    //                            {"timestamp": 35923, "levelValue": 27.9, "temperatureValue": 20.2, "humidityValue": 37, "pressureValue": 103273.25}, 
                    //                            {"timestamp": 36012, "levelValue": 27.5, "temperatureValue": 20.6, "humidityValue": 31, "pressureValue": 103385.64}, 
                    //                        ]
                    //                },
                    //            "S9":
                    //                {
                    //                    "ip":"192.168.0.112", 
                    //                    "record": 
                    //                        [
                    //                            {"timestamp": 35729, "levelValue": 27.3, "temperatureValue": 20.1, "humidityValue": 30, "pressureValue": 103234.45}, 
                    //                            {"timestamp": 35871, "levelValue": 27.1, "temperatureValue": 20.7, "humidityValue": 35, "pressureValue": 103453.62}, 
                    //                            {"timestamp": 35923, "levelValue": 27.9, "temperatureValue": 20.2, "humidityValue": 37, "pressureValue": 103273.25}, 
                    //                            {"timestamp": 36012, "levelValue": 27.5, "temperatureValue": 20.6, "humidityValue": 31, "pressureValue": 103385.64}, 
                    //                        ]
                    //                },
                    //        ]
                    //}

                    res = result.result

                    if(res == "OK"){

                        divChart = $("#chartTableDiv");

                        // -----------
                        //
                        // WATER LEVEL
                        //
                        // -----------

                        //
                        // Water level CHART
                        //
                        if(levelChart == null){

                            levelCanvasId = "levelCanvas";
                            rowData = $('<canvas id="' + levelCanvasId + '" class="chart-canvas">');

                            div = $('<div class="flex-chart-item">');
                            div.append(rowData);
                            divChart.append(div);
                            levelChart=constructChartCanvas(levelCanvasId, "Water Level", "Level [cm]");
                        }

                        // -----------
                        //
                        // TEMPERATURE
                        //
                        // -----------

                        //
                        // Temperature CHART
                        //
                        if(temperatureChart == null){

                            temperatureCanvasId = "temperatureCanvas";
                            rowData = $('<canvas id="' + temperatureCanvasId + '" class="chart-canvas">');

                            div = $('<div class="flex-chart-item">');
                            div.append(rowData);
                            divChart.append(div);
                            temperatureChart=constructChartCanvas(temperatureCanvasId, "Temperature", "Temperature [CÂ°]");
                        }

                        // -----------
                        //
                        // HUMIDITY
                        //
                        // -----------

                        //
                        // Humidity CHART
                        //
                        if(humidityChart == null){

                            humidityCanvasId = "humidityCanvas";
                            rowData = $('<canvas id="' + humidityCanvasId + '" class="chart-canvas">');

                            div = $('<div class="flex-chart-item">');
                            div.append(rowData);
                            divChart.append(div);

                            humidityChart=constructChartCanvas(humidityCanvasId, "Humidity", "Humidity [%]");
                        }

                        // -----------
                        //
                        // PRESSURE
                        //
                        // -----------

                        //
                        // Pressure CHART
                        //
                        if(pressureChart == null){

                            pressureCanvasId = "pressureCanvas";
                            rowData = $('<canvas id="' + pressureCanvasId + '" class="chart-canvas">');

                            div = $('<div class="flex-chart-item">');
                            div.append(rowData);
                            divChart.append(div);

                            pressureChart=constructChartCanvas(pressureCanvasId, "Pressure", "Pressure [mmHg]");
                        }


                        //
                        // === fill up the data lists for charts === //
                        //

                        var chartColorList = [
                            {line: "#0000FF", fill: "rgba(0,0,255, 0.5)" },
                            {line: "#f542ef", fill: "rgba(245, 66, 239, 0.5)" },
                            {line: "#f59c42", fill: "rgba(246, 156, 66, 0.5)" },
                            {line: "#927266", fill: "rgba(146,114, 102, 0.5)" },
                            {line: "#00dbb6", fill: "rgba(0, 219, 182, 0.5)" },
                            {line: "#ff0000", fill: "rgba(255, 0, 0, 0.5)" },
                            {line: "#06a300", fill: "rgba(6, 163, 0, 0.5)" },
                            {line: "#40d3fd", fill: "rgba(64, 211, 253, 0.5)" },
                            {line: "#ffff00", fill: "rgba(255, 255, 0, 0.5)" },
                            {line: "#be00ff", fill: "rgba(190, 0, 255, 0.5)" },
                        ]

                        levelChart.data.datasets=[];
                        temperatureChart.data.datasets=[];
                        humidityChart.data.datasets=[];
                        pressureChart.data.datasets=[];

                        colorIndex=0;
                        // Here takes the the data list
                        // charts =
                        //        [
                        //            "S5":
                        //                {
                        //                    "ip":"192.168.0.117", 
                        //                    "record": 
                        //                        [
                        //                            {"timestamp": 35729, "levelValue": 27.3, "temperatureValue": 20.1, "humidityValue": 30, "pressureValue": 103234.45}, 
                        //                            {"timestamp": 35871, "levelValue": 27.1, "temperatureValue": 20.7, "humidityValue": 35, "pressureValue": 103453.62}, 
                        //                            {"timestamp": 35923, "levelValue": 27.9, "temperatureValue": 20.2, "humidityValue": 37, "pressureValue": 103273.25}, 
                        //                            {"timestamp": 36012, "levelValue": 27.5, "temperatureValue": 20.6, "humidityValue": 31, "pressureValue": 103385.64}, 
                        //                        ]
                        //                },
                        //            "S9":
                        //                {
                        //                    "ip":"192.168.0.112", 
                        //                    "record": 
                        //                        [
                        //                            {"timestamp": 35729, "levelValue": 27.3, "temperatureValue": 20.1, "humidityValue": 30, "pressureValue": 103234.45}, 
                        //                            {"timestamp": 35871, "levelValue": 27.1, "temperatureValue": 20.7, "humidityValue": 35, "pressureValue": 103453.62}, 
                        //                            {"timestamp": 35923, "levelValue": 27.9, "temperatureValue": 20.2, "humidityValue": 37, "pressureValue": 103273.25}, 
                        //                            {"timestamp": 36012, "levelValue": 27.5, "temperatureValue": 20.6, "humidityValue": 31, "pressureValue": 103385.64}, 
                        //                        ]
                        //                },
                        //        ]
                        charts = result.data;
                        $.map(charts,function(graph, index){

                            id=index;
                            record=graph.record


                            levelDataList = [];
                            temperatureDataList = [];
                            humidityDataList = [];
                            pressureDataList = [];

                            $.map(record,function(rec){
                                record = {}
                                record.x=new Date(rec.timeStamp*1000);
                                record.y=rec.levelValue;
                                levelDataList.push(record);

                                record = {}
                                record.x=new Date(rec.timeStamp*1000);
                                record.y=rec.temperatureValue;
                                temperatureDataList.push(record);

                                record = {}
                                record.x=new Date(rec.timeStamp*1000);
                                record.y=rec.humidityValue;
                                humidityDataList.push(record);

                                record = {}
                                record.x=new Date(rec.timeStamp*1000);
                                record.y=(rec.pressureValue)/133.322;
                                pressureDataList.push(record);

                            });

                            levelData = {
                                lineTension: 0,
                                label: id,
                                showLine: true,
                                fill: false,
                                borderColor: chartColorList[colorIndex].line,
                                backgroundColor: chartColorList[colorIndex].fill,
                                pointRadius: 2,
                                pointStyle: 'circle',
                                data: levelDataList,
                            };

                            // --- Temperature ---
                            temperatureData = {
                                lineTension: 0,
                                label: id,
                                showLine: true,
                                fill: false,
                                borderColor: chartColorList[colorIndex].line,
                                backgroundColor: chartColorList[colorIndex].fill,
                                pointRadius: 2,
                                pointStyle: 'circle',
                                data: temperatureDataList,
                            };

                            // --- Humidity ---
                            humidityData = {
                                lineTension: 0,
                                label: id,
                                showLine: true,
                                fill: false,
                                borderColor: chartColorList[colorIndex].line,
                                backgroundColor: chartColorList[colorIndex].fill,
                                pointRadius: 2,
                                pointStyle: 'circle',
                                data: humidityDataList,
                            };
                            humidityBeginAtZero = false;
                            humiditySuggestedMin = 20;
                            humiditySuggestedMax = 100;

                            // --- Pressure ---
                            pressureData = {
                                lineTension: 0,
                                label: id,
                                showLine: true,
                                fill: false,
                                borderColor: chartColorList[colorIndex].line,
                                backgroundColor: chartColorList[colorIndex].fill,
                                pointRadius: 2,
                                pointStyle: 'circle',
                                data: pressureDataList,
                            };
                            pressureBeginAtZero = false;
                            pressureSuggestedMin = 750;
                            pressureSuggestedMax = 770;

                            levelChart.data.datasets.push(levelData);

                            temperatureChart.data.datasets.push(temperatureData);

                            humidityChart.data.datasets.push(humidityData);
                            humidityChart.options.scales.y.beginAtZero = humidityBeginAtZero;
                            humidityChart.options.scales.y.suggestedMin = humiditySuggestedMin;
                            humidityChart.options.scales.y.suggestedMax = humiditySuggestedMax;

                            pressureChart.data.datasets.push(pressureData);
                            pressureChart.options.scales.y.beginAtZero = pressureBeginAtZero;
                            pressureChart.options.scales.y.suggestedMin = pressureSuggestedMin;
                            pressureChart.options.scales.y.suggestedMax = pressureSuggestedMax;

                            colorIndex = (colorIndex + 1) % chartColorList.length;

                        });

                        levelChart.update();
                        temperatureChart.update();
                        humidityChart.update();
                        pressureChart.update();

                    }else{
                        //$("#value").html("");
                        $("#errormessage").html("something went wrong");
                        $("#spinner").hide();
                    }

                    $("#errormessage").html("");
                },
                error: function(xhr,status,error){
                    //$("#value").html("");
                    $("#errormessage").html(xhr.statusText + " " + xhr.responseText);
                    $("#spinner").hide();
                }
            });
        }

        // =========================================================================================================================
        //
        // Open Chart Window
        //
        // I pass chart object as parameter to the new window
        //
        // ========================================================================================================================
        function openChartWindow(chart, event, index){
            console.log(chart);

            var url = 'chart.html';
            window.prePopObj = chart;
            var newWindow = window.open('', chart.options.plugins.title.text, '');
            newWindow.location.href = url;
            newWindow.focus();

        }



        // ================================================
        //
        // Build up recent pumps
        //
        // ================================================


        function buildUpRecentPumps(){

            $.get("/pump/list").done(
                function( data ) {

                    // Collect the recently registered pumps
                    for (lD of data["pump-list"]) {
                        pump_id = lD["pump_id"];
                        pump_ip = lD["pump_ip"];
                        pump_conv_ip = convIp(pump_ip);
                        pumpDict[pump_ip] = {"name": pump_id, "conv-ip": pump_conv_ip, "id-error-msg": "id-pump-error-" + pump_conv_ip, "id-warning-img": "id-pump-warning-img-" + pump_conv_ip, "id-switch": "id-pump-switch-" + pump_conv_ip, "id-slider": "id-pump-slider-" + pump_conv_ip, "id-amount": "id-pump-amount-" + pump_conv_ip, "id-pie": "id-pump-pie-" + pump_conv_ip}
                    }

                    // Go through all the so far registered pumps
                    for (const [key, value] of Object.entries(pumpDict)) {

                        // If it was not registered yet, build up the table for it
                        if($("#" + value["id-switch"]).length == 0){

                            // --------------------
                            // Creates the elements
                            // --------------------

                            // height because of the pie-chart size
                            tr = $('<tr style="height:44px;"></tr>');

                            td_align = $('<td style="width:2.0em;"></td>');
                            tr.append(td_align);

                            td_name = $('<td style="width:15.0em;"></td>');
                            td_name.text(value["name"]);
                            tr.append(td_name);

                            td_switch = $('<td style="width:4em;"></td>');

                            form_switch = $('<input type="checkbox"></input>');
                            form_switch.attr('name', key);
                            form_switch.attr('value', '1');
                            form_switch.attr('class', 'lcs_check');
                            form_switch.attr('id',  value["id-switch"]);

                            td_switch.append(form_switch);
                            tr.append(td_switch);


                            // Empty
                            td_empty = $('<td class="empty" style="width:1.0em;"></td>');
                            tr.append(td_empty);

                            // Slider
                            td_slider = $('<td valign="center" style="width:10em;"></td>');
                            td_slider_table = $('<table>');
                            td_slider_table.attr('width', '100%');
                            td_slider_table_tr = $('<tr></tr>');
                            td_slider_table_td = $('<td></td>');
                            td_slider_table_td.attr('id', value["id-slider"]);

                            td_slider_table_td.append(td_slider_table_tr);
                            td_slider_table.append(td_slider_table_td)
                            td_slider.append(td_slider_table);
                            tr.append(td_slider);

                            // Empty
                            td_empty = $('<td class="empty" style="width:1.0em;"></td>');
                            tr.append(td_empty);

                            // Amount
                            td_amount = $('<td valign="center" style="width:4.0em;"></td>');
                            td_amount.attr('id', value["id-amount"]);
                            tr.append(td_amount);

                            // Pie-chart
                            td_pie = $('<td style="width:3.0em;"></td>');
                            td_pie_div = $('<div></div>');
                            td_pie_div.attr('id', value["id-pie"]);
                            td_pie_div.attr("class", "chart");
                            td_pie_div.attr("data-percent", "0");

                            td_pie.append(td_pie_div);
                            tr.append(td_pie);

                            td_warning = $('<td style="width:1.3em;">');
                            td_warning.attr('id', value["id-warning-img"]);
                            img_warning = $('<img style="width:1.3em;"></img>');
                            td_warning.append(img_warning);
                            tr.append(td_warning);

                            td_error = $('<td style="color:rgb(255,0,0)"></td>');
                            td_error.attr('id', value["id-error-msg"]);
                            tr.append(td_error)

                            $("#pump-table").append(tr);

                            // ----------------------
                            // Configure the elements
                            // ----------------------

                            // Format pump checkbox to switch
                            lc_switch("#" + value["id-switch"], {
                                on_txt      : 'ON',
                                off_txt     : 'OFF',
                                on_color    : false,
                                compact_mode: false
                            });

                            td_slider_table_td.slider({
                                value:10,
                                min: 10,
                                max: 90,
                                step: 10,
                                slide: function( event, ui ) {
                                    td_amount.text( ui.value + "sec" );
                                }
                            });
                            td_amount.text( td_slider_table_td.slider( "value" ) + "sec" );

                            //$('#' + value["id-pie"]).easyPieChart({
                            td_pie_div.easyPieChart({
                                barColor: '#ef1e25',
                                trackColor: '#f9f9f9',
                                scaleColor: '#dfe0e0',
                                scaleLength: 5,
                                lineCap: 'round',
                                lineWidth: 3,
                                trackWidth: 3,
                                size: 40,
                                rotate: 0, // in degrees
                                animate: {
                                  duration: 1000,
                                  enabled: true
                                },
                                easing: function (x, t, b, c, d) { // easing function
                                  t = t / (d/2);
                                  if (t < 1) {
                                    return c / 2 * t * t + b;
                                  }
                                  return -c/2 * ((--t)*(t-2) - 1) + b;
                                }
                            });
                        }

<!-- <> -->

                        // ------------------------------------------------------------------
                        // Check the status - and set the value - for all yet registere lamps
                        // ------------------------------------------------------------------

                        $.get( "/pump/status/ip/" + key).done(
                            function( data ) {

                                // Disable Even on the swith
                                $("#" + value["id-switch"]).off('lcs-on lcs-off');

                                if (data.data === null){
                                    // Control the Pie-Chart
                                    $("#" + value["id-pie"]).hide();

                                    lcs_off("#" + value["id-switch"]);
                                    lcs_disable("#" + value["id-switch"]);

                                    $("#" + value["id-warning-img"] + " img").css('visibility','visible');
                                    $("#" + value["id-warning-img"] + " img").attr('src', "warning-icon.png");
                                    $("#" + value["id-error-msg"]).text("No control on pump");


                                }else if (data.data.status == 'on'){
                                    lcs_on("#" + value["id-switch"]);
                                    lcs_enable("#" + value["id-switch"]);

                                    $("#" + value["id-warning-img"] + " img").css('visibility','hidden');
                                    $("#" + value["id-error-msg"]).text("");

                                    // Control the Pie-Chart
                                    let percentage = parseInt(data['data'].percentage * 100);
                                    $("#" + value["id-pie"]).show();
                                    $("#" + value["id-pie"]).data('easyPieChart').update(percentage);

                                }else if (data.data.status == 'off'){
                                    lcs_off("#" + value["id-switch"]);
                                    lcs_enable("#" + value["id-switch"]);

                                    $("#" + value["id-warning-img"] + " img").css('visibility','hidden');
                                    $("#" + value["id-error-msg"]).text("");

                                    // Control the Pie-Chart
                                    $("#" + value["id-pie"]).hide();


                                    // If I sent the trigger report before the pump started, now I will send a new trigger report after the pump stopped
                                    if (triggerReportBeforeSent){

                                        //send trigger to report
                                        $.post( "/sensor/trigger/report" );

                                        //indicate that the trigger report was sent before the pump started and sent after the pump stopped
                                        triggerReportBeforeSent = false;

                                        //refresh the chart
                                        refreshCharts();

                                        const now = new Date();
                                        const isoDate = now.toISOString();
                                        console.log("End trigger report request has been sent: " + isoDate);
                                    }

                                }else{
                                    // Control the Pie-Chart
                                    $("#" + value["id-pie"]).hide();

                                    lcs_off("#" + value["id-switch"]);
                                    lcs_disable("#" + value["id-switch"]);

                                    $("#" + value["id-warning-img"] + " img").css('visibility','visible');
                                    $("#" + value["id-warning-img"] + " img").attr('src', "warning-icon.png");
                                    $("#" + value["id-error-msg"]).text("No control on pump");

                                }

                                // Enables Event on the switch
                                $("#" + value["id-switch"]).on('lcs-on', pumpOnEvent);
                                $("#" + value["id-switch"]).on('lcs-off', pumpOffEvent);
                            }
                        );
                    }
                }
            );
        }



        // ================================================
        //
        // Build up recent lamps
        //
        // ================================================
        function buildUpRecentLamps(){

            $.get("/lamp/list").done(
                function( data ) {

                    // Collect the recently registered lamps
                    for (lD of data["lamp-list"]) {
                        lamp_id = lD["lamp_id"];
                        lamp_ip = lD["lamp_ip"];
                        lamp_conv_ip = convIp(lamp_ip);
                        lampDict[lamp_ip] = {"name": lamp_id, "conv-ip": lamp_conv_ip, "id-error-msg": "id-lamp-error-" + lamp_conv_ip, "id-warning-img": "id-lamp-warning-img-" + lamp_conv_ip, "id-switch": "id-lamp-switch-" + lamp_conv_ip}
                    }

                    // Go through all the so far registered lamps
                    for (const [key, value] of Object.entries(lampDict)) {

                        // If it was not registered yet, build up the table for it
                        if($("#" + value["id-switch"]).length == 0){

                            // height because of the PUMP pie-chart size
                            tr = $('<tr style="height:44px;"></tr>');


                            td_align = $('<td style="width:2.0em;"></td>');
                            tr.append(td_align);

                            td_name = $('<td style="width:15.0em;"></td>');
                            td_name.text(value["name"]);
                            tr.append(td_name);

                            td_switch = $('<td style="width:4em;"></td>');

                            form_switch = $('<input type="checkbox"></input>');
                            form_switch.attr('name', key);
                            form_switch.attr('value', '1');
                            form_switch.attr('class', 'lcs_check');
                            form_switch.attr('id',  value["id-switch"]);

                            td_switch.append(form_switch);
                            tr.append(td_switch);

                            td_empty = $('<td class="empty" style="width:1.0em;"></td>');
                            tr.append(td_empty);
                            td_empty = $('<td class="empty" style="width:10em;"></td>');
                            tr.append(td_empty);
                            td_empty = $('<td class="empty" style="width:1.0em;"></td>');
                            tr.append(td_empty);
                            td_empty = $('<td class="empty" style="width:4.0em;"></td>');
                            tr.append(td_empty);
                            td_empty = $('<td class="empty" style="width:3.0em;"></td>');
                            tr.append(td_empty);

                            td_warning = $('<td style="width:1.3em;">');
                            td_warning.attr('id', value["id-warning-img"]);
                            img_warning = $('<img style="width:1.3em;"></img>');
                            td_warning.append(img_warning);
                            tr.append(td_warning);

                            td_error = $('<td style="color:rgb(255,0,0)"></td>');
                            td_error.attr('id', value["id-error-msg"]);
                            tr.append(td_error)

                            $("#lamp-table").append(tr);

                            // ----------------------
                            // Configure the elements
                            // ----------------------

                            // Format lamp checkbox to switch
                            lc_switch("#" + value["id-switch"], {
                                on_txt      : 'ON',
                                off_txt     : 'OFF',
                                on_color    : false,
                                compact_mode: false
                            });
                        }

                        // ------------------------------------------------------------------
                        // Check the status - and set the value - for all yet registere lamps
                        // ------------------------------------------------------------------

                        $.get( "/lamp/status/ip/" + key).done(
                            function( data ) {

                                // Disable Even on the swith
                                $("#" + value["id-switch"]).off('lcs-on lcs-off');

                                if (data['data'].status == 'on'){
                                    lcs_on("#" + value["id-switch"]);
                                    lcs_enable("#" + value["id-switch"]);

                                    $("#" + value["id-warning-img"] + " img").css('visibility','hidden');
                                    $("#" + value["id-error-msg"]).text("");
                                }else if (data['data'].status == 'off'){
                                    lcs_off("#" + value["id-switch"]);
                                    lcs_enable("#" + value["id-switch"]);

                                    $("#" + value["id-warning-img"] + " img").css('visibility','hidden');
                                    $("#" + value["id-error-msg"]).text("");
                                }else{
                                    lcs_off("#" + value["id-switch"]);
                                    lcs_disable("#" + value["id-switch"]);

                                    $("#" + value["id-warning-img"] + " img").css('visibility','visible');
                                    $("#" + value["id-warning-img"] + " img").attr('src', "warning-icon.png");
                                    $("#" + value["id-error-msg"]).text("No control on lamp");
                                }

                                // Enables Event on the switch
                                $("#" + value["id-switch"]).on('lcs-on', lampOnEvent);
                                $("#" + value["id-switch"]).on('lcs-off', lampOffEvent);
                            }
                        );
                    }
                }
            );
        }


        // ================================================
        //
        // check lamp status
        //
        // ================================================
        function checkLampStatus(){
            buildUpRecentLamps()
        }

        // ================================================
        //
        // Lamp ON/OFF Event
        //
        // ================================================
        function lampOnEvent(e){
            ip = e.target.name;
            $.post( "/lamp/switch", { "status": "on", "lengthInSec": "10", "ip": ip } );
        }

        function lampOffEvent(e){
            ip = e.target.name;
            $.post( "/lamp/switch", { "status": "off", "lengthInSec": "10", "ip": ip } );
        }


        // ================================================
        //
        // check pump status
        //
        // ================================================
        function checkPumpStatus(){
            buildUpRecentPumps();
        }

        // ================================================
        //
        // Pump ON/OFF Event
        //
        // ================================================
        function pumpOnEvent(e){
            ip = e.target.name;
            slider_id = pumpDict[ip]['id-slider'];
            switch_id = pumpDict[ip]['id-switch'];

            //first check the state of the pump
            $.get( "/pump/status/ip/" + ip).done(
                function( data ) {

                    //if the pump is OFF
                    if (data.data.status == 'off' && !triggerReportBeforeSent){

                        lcs_disable("#" + switch_id);

                        const now = new Date();
                        const isoDate = now.toISOString();
                        console.log("Sending pump turnOn signal and trigger report request " + isoDate);

                        //the pump can be turn ON
                        $.post( "/pump/turnOn", { "lengthInSec": $( "#" + slider_id ).slider( "value" ), "ip": ip } );

                        //send trigger to report
                        $.post( "/sensor/trigger/report" );

                        //indicate that the trigger report was sent before the pump started
                        triggerReportBeforeSent = true;

                        lcs_enable("#" + switch_id);

                    }
                }
            );
        }


        function pumpOffEvent(e){
            ip = e.target.name;
            $.post( "/pump/turnOff", {"ip": ip} );

        }

        // ================================================
        // ================================================
        //
        //  When the page is loaded
        //
        // ================================================
        // ================================================
        $(document).ready(function(){

            $("#spinner").hide();

            buildUpRecentPumps()

            buildUpRecentLamps()

            //-----------------------
            // Start Date
            //-----------------------
            $( "#startDatePicker" ).datepicker({
                dateFormat: 'yy-mm-dd',
                changeMonth: true,
                changeYear: true,
                changeHour: true,
            });

            var date = new Date();
            var weekBefore = new Date(date.getFullYear(), date.getMonth(), date.getDate() - 7);
            $('#startDatePicker').datepicker('setDate', weekBefore);

            //-----------------------
            // End Date
            //-----------------------
            $( "#endDatePicker" ).datepicker({
                dateFormat: 'yy-mm-dd',
                changeMonth: true,
                changeYear: true,
                changeHour: true,
            });

            //-----------------------
            // Refresh Chart Button
            //-----------------------
            $("#refreshChartButton").click(function(){
                //startDate = $('#startDatePicker').val();
                //var date = new Date(startDate);
                //startYear = date.getFullYear()
                //startMonth = date.getMonth() + 1
                //startDay = date.getDate()
                //console.log( startYear + "." + startMonth + "." + startDay);

                $("#spinner").show();

                refreshCharts();
            });

            constructCamCaptureSection();


            //-----------------------
            // Tab
            //-----------------------
            $( "#tabs" ).tabs({

                // Initial TAB = Control-Tab
                active: 0

            });

            $(".ui-tabs .ui-tabs-panel").css('padding', '0em');


            //-----------------------
            // Refresh Lamp Status
            //-----------------------
            checkLampStatusRefreshIntervalId = setInterval(checkLampStatus, intervalCheckLamp);

            //-----------------------
            // Refresh Pump Status
            //-----------------------
            checkPumpStatusRefreshIntervalId = setInterval(checkPumpStatus, intervalCheckPump);


            $( "#tabs" ).tabs({
               activate: function( event, ui ) {

                    // Leave Control-Tab
                    if(ui.oldTab.index() == 0){

                        // No more Check Lamp Status request
                        clearInterval(checkLampStatusRefreshIntervalId);

                        // No more Check Pump Status request
                        // clearInterval(checkPumpStatusRefreshIntervalId);

                    // Leave Chart-Tab
                    }else if(ui.oldTab.index() == 1){

                        // No more Chart refresh request
                        clearInterval(chartRefreshIntervalId);

                    // Leave Cam-Tab
                    }else if( ui.oldTab.index() == 2){

                        // No more Cam Capture request
                        clearInterval(camCaptureRefreshIntervalId);
                    }


                    //
                    // Select Control-Tab
                    //
                    if(ui.newTab.index() == 0){

                        //-----------------------
                        // Refresh Lamp Status
                        //-----------------------
                        checkLampStatusRefreshIntervalId = setInterval(checkLampStatus, intervalCheckLamp);

                        //-----------------------
                        // Refresh Lamp Status
                        //-----------------------
                        // checkPumpStatusRefreshIntervalId = setInterval(checkPumpStatus, intervalCheckPump);

                    // Select Chart-Tab
                    }else if(ui.newTab.index() == 1){

                        //-----------------------
                        // Refresh Charts
                        //-----------------------
                        chartRefreshIntervalId = setInterval(refreshCharts, intervalCheckChart);

                    // Select Cam-Tab
                    }else if( ui.newTab.index() == 2){

                        //-----------------------
                        // Refresh Cam Capture
                        //-----------------------
                        camCaptureRefreshIntervalId = setInterval(refreshCamCapture, intervalCheckCam);
                    }
                }
            });


            // control the triggerReport button
            $("#triggerReportButton").on( "click", function() {
                $.post( "/sensor/trigger/report" );
                console.log("manual trigger");
            });


        });

    </script>

</head>

<body style="background-color:DarkGrey;">

    <div class="header" style="position:relative; text-align:center; color:white; text-shadow: 2px 2px 2px green; ">
        <img src="header.jpg" style="width:100%"/>
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); font-weight:bolder; font-size:5vw">Green Wall</div>
    </div>

    <div id="tabs" style="background: none repeat scroll 0% 0% rgb(204, 204, 204);">
        <ul>
            <li><a href="#tabs-control">Control</a></li>
            <li><a href="#tabs-charts">Charts</a></li>
            <li><a href="#tabs-cam">Cam</a></li>
        </ul>

        <!--         -->
        <!-- CONTROL -->
        <!--         -->
        <div id="tabs-control">

            <table id="controller" border="0" class="switch">

                <!-- LAMPS --->
                <tr>
                    <td colspan="10" valign="top" style="font-weight:bold; font-size:1.3em">Lamps:</td>
                </tr>
                <tr>
                    <td colspan="10">

                        <table border="0" width="100%" id="lamp-table">
<!--                            <tr>
                                <td style="width:2.0em;"> </td>
                                <td style="width:15.0em;">my lamp #1:</td>
                                <td id="myip" style="width:4em;">
                                    <form>
                                        <input type="checkbox" name="lampSwitch" value="1" class="lcs_check" id="id-lamp-switch-192-168.50.132"/>
                                    </form>
                                </td>
                                <td class="empty" style="width:1.3em;"> </td>
                                <td id="id-lamp-warning-img-192.168.50.132" valign="top" style="width:1.3em;">
                                    <img  style="width:1.3em;" />
                                </td>
                                <td id="id-lamp-error-192-168-50-132" valign="top" style="color:rgb(255,0,0)"></td>

                            </tr>
-->
                        </table>
                    </td>
                </tr>

                <!-- PUMPS --->
                <tr>
                    <td colspan="10" valign="top" style="font-weight:bold; font-size:1.3em">Pumps:</td>
                </tr>
                    <td colspan="10">

                        <table border="0" width="100%" id="pump-table">

<!--                            <tr>
                                <td style="width:2.0em;"> </td>
                                <td style="width:15.0em;">my pump #1:</td>
                                <td id="myip" style="width:4em;">
                                    <form>
                                        <input type="checkbox" name="pumpSwitch" value="1" class="lcs_check" id="id-pump-switch-192-168.50.66"/>
                                    </form>
                                </td>

                                <td style="width:1.0em"/>
                                <td valign="center" style="width:10em">
                                    <table width="100%">
                                        <tr>
                                            <td id="id-pump-slider-192-168-50-66"></td>
                                        </tr>
                                    </table>
                                </td>
                                <td style="width:1.0em"/>

                                <td valign="center" id="id-pump-amount-192-168-50-66" style="width:4em; "/>
                                <td style="width:3.0em">
                                    <!-- Pump pie --> <!--
                                    <div id="id-pump-pie-chart-192-168-50-66" class="chart" data-percent="0">
                                        <span  class="chart" data-percent="0">
                                            <span class="percent"></span>
                                        </span>
                                    </div>
                                </td>

                                <td id="id-pump-warning-img-192.168.50.66" valign="top" style="width:1.3em;">
                                    <img  style="width:1.3em;" />
                                </td>
                                <td id="id-pump-error-192-168-50-66" valign="top" style="color:rgb(255,0,0)"></td>

                            </tr>
-->
                        </table>
                    </td>
                </tr>





            </table>

        </div>




        <!--        -->
        <!-- CHARTS -->
        <!--        -->
        <div id="tabs-charts">

            <table id="dateFilter" border="0">
                <tr>
                    <td> Start date:</td>
                    <td><input type="text" id="startDatePicker" size="8"> </td>
                    <td rowspan="2"><button id="refreshChartButton">Refresh</button></td>
                    <td rowspan="2" width="60px"><img id="spinner" src="spinner.gif" width="60"></td>
                </tr>
                <tr>
                    <td> End date:</td>
                    <td><input type="text" id="endDatePicker" size="8"> </td>
                </tr>

                <tr>
                    <td/>
                    <td colspan="4">
                        <a id="triggerReportButton" class="button">
                            <span>Trigger report</span>
                        </a>
                    </td>
                </tr>





            </table>

            <div id="chartTableDiv" class="flex-chart-container"></div>

            <div id="errormessage"></div>
        </div>

        <!--     -->
        <!-- CAM -->
        <!--     -->
        <div id="tabs-cam">
        </div> 

    </div>

</body>
</html>