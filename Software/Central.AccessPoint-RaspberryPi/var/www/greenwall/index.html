<meta charset="UTF-8" comntent="text/html;charset=utf-8" http-equiv="Content-Type">

<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1">

<html>
<head>

    <title>Green Wall</title>

    <style>

        /* camCapture in row */
        * {
            box-sizing: border-box;
        }

        .row {
            display: flex;
        }

        /* Create three equal columns that sits next to each other */
        .column {
            padding: 5px;
        }

        /* General fonts */
        * {
            font-size: 18px;
        }

        h1 {
            font-size: 40px;
        }

        #dateFilter {
            margin-left: auto;
            margin-right: auto;
        }

        #errormessage {
            color: red;
            font-weight: bold;
        }

        #labelstationid {
            white-space: nowrap;
            font-size: 18pt;
            font-weight: bold;
            -moz-transform: rotate(-90deg);
            -moz-transform-origin: center center;
            -webkit-transform: rotate(-90deg);
            -webkit-transform-origin: center center;
            -ms-transform: rotate(-90deg);
            -ms-transform-origin: center center;
            max-width: 2em;
            display: inline-block;
        }

        button{
            height: 60px;
            vertical-align: top;
        }

        .chart-canvas{
            min-height:auto;
            width: 100%;
            background-color: rgb(152, 251, 152);
            padding: 0px;
            border: 1px solid;
        }

        /* CAM title aligned to center */
        .cam-img-title {
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size:1.5em;
        }

        /* CHART title aligned to center */
        .chart-img-title {
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size:1.5em;
        }

        /* CAM containder for tables to be flex  */
        .flex-cam-container {
            display: flex;
            flex-wrap: wrap;
            ppadding: 5px;
            justify-content: flex-start;
        }

        /* CHART containder for tables to be flex  */
        .flex-chart-container {
            display: flex;
            flex-wrap: wrap;
            padding: 5px;
            justify-content: flex-start;
        }

        /* 3 pictures per line on normal screen with adaptive size */
        .flex-cam-item {
            mmargin: 5px;
            width: 33.3%;
        }

        /* 3 charts per line on normal screen with adaptive size */
        .flex-chart-item {
            mmargin: 5px;
            padding: 2px;
            width: 33.3%;
        }

        /* 1 picture/chart per line on vertical mobile with adaptive size */
        @media (max-width: 600px) {
            .flex-cam-item {
                float: none;
                width: 100%;
            }
        }

        /* 1 picture/chart per line on vertical mobile with adaptive size */
        @media (max-width: 900px) {
            .flex-chart-item {
                float: none;
                width: 100%;
            }
        }

    </style>

    <!-- Chart -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.8.0/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/1.30.1/date_fns.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <!-- JQuery -->
    <script src="script/jquery/jquery-3.6.0.min.js"></script>
    <script src="script/jquery-ui/jquery-ui.min.js"></script>

    <link href="script/jquery-ui/jquery-ui.css" rel="stylesheet">
    <link href="script/roundedbutton/css/style.css" rel="stylesheet" />

    <!-- Switch -->
    <script src="script/switch/lc_switch.js"></script>

    <!-- moment -->
    <script src="script/moment/moment.js"></script>

    <!-- favicon -->
    <link rel="shortcut icon" href="favicon.ico">

    <script>

        var levelData = [];
        var temperatureData = [];
        var humidityData = [];
        var pressureData = [];

        var camCaptureList = [];

        var chartRefreshIntervalId = null;
        var camCaptureRefreshIntervalId = null;
        var checkLampStatusRefreshIntervalId = null;
        var checkPumpStatusRefreshIntervalId = null;

        var levelChart = null;
        var temperatureChart = null;
        var humidityChart = null;
        var pressureChart = null;

        $( function() {
            $( "#tabs" ).tabs();
        } );

        function isEmpty(str) {
            return (!str || str.length === 0 );
        }

        // =============================
        //
        // Construct Cam Capture Section
        //
        // =============================
        function constructCamCaptureSection(){

            $.ajax({type: "GET", url: "/cam/captureList", async: true,
                success: function(result){

                    res = result.result

                    if(res == "OK"){

                        newCamCaptureList = [];
                        $.map(result.camCaptureList, function(camCapture){

                            camId = camCapture.camId;
                            camCaptureUrl = camCapture.captureUrl;

                            cc = {};
                            cc['camId'] = camId;
                            cc['camCaptureUrl'] = camCaptureUrl;
                            newCamCaptureList.push(cc);
                        });

                        newCamCaptureList.sort(function(a, b){return a.camId > b.camId});

                        //If the old and new list is the same, does not need to re-build the camCaptureDiv
                        if( newCamCaptureList.length === camCaptureList.length && newCamCaptureList.every(function(value, index) { return value.camId === camCaptureList[index].camId }) ){
                            return;
                        }

                        divCam = $('<div id="camCaptureDiv" class="flex-cam-container">');

                        camCaptureList = newCamCaptureList;
                        $.map(camCaptureList, function(camCapture){

                            camId = camCapture.camId;
                            camCaptureUrl = camCapture.captureUrl;

                            //
                            // TITLE
                            //
                            title=$('<div class="cam-img-title" style="font-size:1.5em">');
                            title.html(camId);

                            //
                            // IMG
                            //
                            var img = $('<img id="cam_' + camId + '">');

                            // Random value after the image name helps to ignore the cache at refresh
                            img.attr('src', '/greenwall/cam-capture/capture_' + camId + '.jpg?' + Math.random());
                            img.attr('style', 'width: 100%;')

                            //
                            // Build up the Table
                            //
                            var tableBody = $("<tbody>");

                            row = $('<tr>');
                            rowData = $('<td style="padding:0px">');
                            row.append(rowData);
                            rowData = rowData.append(title);
                            row.append(rowData);
                            tableBody.append(row);

                            row = $('<tr>');
                            rowData = $('<td style="padding:0px">');
                            row.append(rowData);
                            rowData = rowData.append(img);
                            row.append(rowData);
                            tableBody.append(row);

                            camTable = $('<table class="flex-cam-item" border="0"></table>');
                            camTable.append(tableBody);
                            divCam.append(camTable);

                        });

                        $('#tabs-cam').html("");
                        $('#tabs-cam').append(divCam);

                        //
                        // Add click event listner to all pictures
                        //
                        $.map(camCaptureList, function(camCapture){

                            camId = camCapture.camId;
                            $("#cam_" + camId).on("click", function(e){

                                // Open window - parameter is the camId
                                // I can not put here simple the camId because it always will be the latest selected value
                                // So I just substring it from the <img id>
                                // The click will be executed on <img> so the 'this' value will refer to the <img>
                                // In the function I will substring the camId value from the parameter
                                openCaptureWindow(this.id);

                            });
                        });

                    }else{
                        //$("#value").html("");
                        //$("#errormessage").html("something went wrong");
                        //$("#spinner").hide();
                    }

//                    $("#errormessage").html("");
                },
                error: function(xhr,status,error){
//                    $("#value").html("");
//                    $("#errormessage").html(xhr.statusText + " " + xhr.responseText);
//                    $("#spinner").hide();
                }
            });
        }


        // =========================================================================================================================
        //
        // Open Capture Window
        //
        // That part is pretty tricky
        // The imgId is the <img id> of the capture image which looks like this: cam_4
        // So I have to substring it to get the camId
        //
        // Then I have to provide this camId to the new window, which I will open
        // I provide it through the window name
        // Solving this problem I tried to dynamically construct that page here and put it into the opened page when it is loaded
        // Unfortunatelly this event listener does not work for Chrome. It worked for Firefox though.
        //
        // Plus I had to solve the problem to NOT to open the already opened cam's window, BUT still have to select it
        //
        // ========================================================================================================================
//!!!!
        function openCaptureWindow(imgId){
            var camId = imgId.substring(4);
            var url = 'capture.html';

            // Here I pass the camId as parameter to the new window
            window.prePopObj = camId;
            var newWindow = window.open('', camId, '');
            if(newWindow.location.href === 'about:blank'){
                newWindow.location.href = url;
            }else{
                newWindow.focus();
            }
        }

        // ================================================
        //
        // Refresh Cam Capture
        //
        // ================================================
        function refreshCamCapture(){
            constructCamCaptureSection();

            $.map(camCaptureList, function(camCapture){

                camId = camCapture.camId;
                //camCaptureUrl = camCapture.captureUrl;

                // Random value after the image name helps to ignore the cache at refresh
                $("#cam_" + camId).attr('src', '/greenwall/cam-capture/capture_' + camId + '.jpg?' + Math.random());
            });
        }

        // ================================================
        //
        // Construct a Chart Canvas
        //
        // ================================================
        function constructChartCanvas(chartCanvasId, title, labelY){
            var myChart = new Chart($("#" + chartCanvasId), {

                type: 'scatter',
                data: {
                    datasets: [
                    ]
                },
                options: {
                    onClick: function (evt, i) {openChartWindow(myChart, evt, i)},
                    aspectRatio:1.5,
                    plugins:{
                        title: {
                            display: true,
                            text: title
                        },
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true
                            }
                        },
                    },
                    responsive: true,
                    scales: {
                        x: {
                            grid: {
                                borderWidth: 2,
                                borderColor: '#000000',
                            },

                            type: 'time',
                            //distribution: 'series',
                            time: {
                                //unitStepSize: 10,
                                //parser: 'yy.MM.dd',
                                unit: 'day',
                                tooltipFormat: 'yyyy.MM.dd HH:mmzzz',
                                displayFormats: {
                                    'hour': 'HH:mmzzz',
                                    'day': 'yyyy.MM.dd',
                                    'week': 'yyyy.MM.dd',
                                    'month': 'yyyy.MM',
                                    'quarter': 'yyyy.MM',
                                    'year': 'yyyy',
                                },
                            },
                            title: {
                                display: false,
                                text: 'Date',
                            },
                            ticks: {

                                // Bold on Sunday
                                font:{
                                    weight: (c) => {
                                        day = new Date(c.tick.value).getDay()
                                        return day == 0 ? 'bold' : 'normal';
                                    }
                                },

                                display: true,
                                minRotation: 20,
                                align: 'center',

                                    //major: {
                                    //   font: 'bold',
                                    //   enabled: false,
                                    //   unit: 'day',
                                    //   fontColor: 'red',
                                    //   unitStepSize: 2,
                                    //   displayFormats: {
                                    //      'day': 'yyyy.MM.dd',
                                    //      'hour': 'yyyy'
                                    //   },
                                    //},

                                // Red color on Sunday
                                color: (c) => {
                                    day = new Date(c.tick.value).getDay()
                                    return day == 0 ? 'red' : 'black';
                                }

                                //callback: function(value, index, ticks) {
                                //   ticks.forEach(t => {
                                //      const day = new Date(t.value).getDay();
                                //      t.major = (day == 0 || day == 6);
                                //   });
                                //   return '$' + value;
                                //}

                            },
                        },
                        y: {
                            grid: {
                                borderWidth: 2,
                                borderColor: '#000000',
                                display: true,
                            },

                            beginAtZero: true,
                            display: true,
                            ticks: {
                                display: true,
                                //stepSize: 10,
                            },
                            title: {
                                display: true,
                                text: labelY
                            },
                        }
                    },
                }
            });
            return myChart;
        }

        // ================================================
        //
        // Refresh Charts
        //
        // ================================================
        function refreshCharts(){

            $("#spinner").show();

            // Fetch the date values from the fields
            startDate = $('#startDatePicker').val();
            endDate = $('#endDatePicker').val();

            if (!isEmpty(endDate)){
                // Add 1 more day construct midnight of endDate
                var date = new Date(endDate);
                date.setDate(date.getDate() + 1)

                endYear = date.getFullYear()
                endMonth = date.getMonth() + 1
                endDay = date.getDate()
            }

            param = "startDate/" + startDate + ( isEmpty(endDate) ? "" : ("/endDate/" + endYear + "-" + endMonth + "-" + endDay))

            $("#errormessage").html("");

            $.ajax({type: "GET", url: "/sensor/data/list/" + param, async: true,
                success: function(result){

                    $("#spinner").hide();

                    //result = 
                    //{
                    //    'result': 'OK', 
                    //    'data':
                    //        [
                    //            "S5":
                    //                {
                    //                    "ip":"192.168.0.117", 
                    //                    "record": 
                    //                        [
                    //                            {"timestamp": 35729, "levelValue": 27.3, "temperatureValue": 20.1, "humidityValue": 30, "pressureValue": 103234.45}, 
                    //                            {"timestamp": 35871, "levelValue": 27.1, "temperatureValue": 20.7, "humidityValue": 35, "pressureValue": 103453.62}, 
                    //                            {"timestamp": 35923, "levelValue": 27.9, "temperatureValue": 20.2, "humidityValue": 37, "pressureValue": 103273.25}, 
                    //                            {"timestamp": 36012, "levelValue": 27.5, "temperatureValue": 20.6, "humidityValue": 31, "pressureValue": 103385.64}, 
                    //                        ]
                    //                },
                    //            "S9":
                    //                {
                    //                    "ip":"192.168.0.112", 
                    //                    "record": 
                    //                        [
                    //                            {"timestamp": 35729, "levelValue": 27.3, "temperatureValue": 20.1, "humidityValue": 30, "pressureValue": 103234.45}, 
                    //                            {"timestamp": 35871, "levelValue": 27.1, "temperatureValue": 20.7, "humidityValue": 35, "pressureValue": 103453.62}, 
                    //                            {"timestamp": 35923, "levelValue": 27.9, "temperatureValue": 20.2, "humidityValue": 37, "pressureValue": 103273.25}, 
                    //                            {"timestamp": 36012, "levelValue": 27.5, "temperatureValue": 20.6, "humidityValue": 31, "pressureValue": 103385.64}, 
                    //                        ]
                    //                },
                    //        ]
                    //}

                    res = result.result

                    if(res == "OK"){

                        divChart = $("#chartTableDiv");

                        // -----------
                        //
                        // WATER LEVEL
                        //
                        // -----------

                        //
                        // Water level CHART
                        //
                        if(levelChart == null){

                            levelCanvasId = "levelCanvas";
                            rowData = $('<canvas id="' + levelCanvasId + '" class="chart-canvas">');

                            div = $('<div class="flex-chart-item">');
                            div.append(rowData);
                            divChart.append(div);
                            levelChart=constructChartCanvas(levelCanvasId, "Water Level", "Level [cm]");
                        }

                        // -----------
                        //
                        // TEMPERATURE
                        //
                        // -----------

                        //
                        // Temperature CHART
                        //
                        if(temperatureChart == null){

                            temperatureCanvasId = "temperatureCanvas";
                            rowData = $('<canvas id="' + temperatureCanvasId + '" class="chart-canvas">');

                            div = $('<div class="flex-chart-item">');
                            div.append(rowData);
                            divChart.append(div);
                            temperatureChart=constructChartCanvas(temperatureCanvasId, "Temperature", "Temperature [C°]");
                        }

                        // -----------
                        //
                        // HUMIDITY
                        //
                        // -----------

                        //
                        // Humidity CHART
                        //
                        if(humidityChart == null){

                            humidityCanvasId = "humidityCanvas";
                            rowData = $('<canvas id="' + humidityCanvasId + '" class="chart-canvas">');

                            div = $('<div class="flex-chart-item">');
                            div.append(rowData);
                            divChart.append(div);

                            humidityChart=constructChartCanvas(humidityCanvasId, "Humidity", "Humidity [%]");
                        }

                        // -----------
                        //
                        // PRESSURE
                        //
                        // -----------

                        //
                        // Pressure CHART
                        //
                        if(pressureChart == null){

                            pressureCanvasId = "pressureCanvas";
                            rowData = $('<canvas id="' + pressureCanvasId + '" class="chart-canvas">');

                            div = $('<div class="flex-chart-item">');
                            div.append(rowData);
                            divChart.append(div);

                            pressureChart=constructChartCanvas(pressureCanvasId, "Pressure", "Pressure [mmHg]");
                        }


                        //
                        // === fill up the data lists for charts === //
                        //

                        var chartColorList = [
                            {line: "#0000FF", fill: "rgba(0,0,255, 0.5)" },
                            {line: "#f542ef", fill: "rgba(245, 66, 239, 0.5)" },
                            {line: "#f59c42", fill: "rgba(246, 156, 66, 0.5)" },
                            {line: "#927266", fill: "rgba(146,114, 102, 0.5)" },
                            {line: "#00dbb6", fill: "rgba(0, 219, 182, 0.5)" },
                            {line: "#ff0000", fill: "rgba(255, 0, 0, 0.5)" },
                            {line: "#06a300", fill: "rgba(6, 163, 0, 0.5)" },
                            {line: "#40d3fd", fill: "rgba(64, 211, 253, 0.5)" },
                            {line: "#ffff00", fill: "rgba(255, 255, 0, 0.5)" },
                            {line: "#be00ff", fill: "rgba(190, 0, 255, 0.5)" },
                        ]

                        levelChart.data.datasets=[];
                        temperatureChart.data.datasets=[];
                        humidityChart.data.datasets=[];
                        pressureChart.data.datasets=[];

                        colorIndex=0;
                        // Here takes the the data list
                        // charts =
                        //        [
                        //            "S5":
                        //                {
                        //                    "ip":"192.168.0.117", 
                        //                    "record": 
                        //                        [
                        //                            {"timestamp": 35729, "levelValue": 27.3, "temperatureValue": 20.1, "humidityValue": 30, "pressureValue": 103234.45}, 
                        //                            {"timestamp": 35871, "levelValue": 27.1, "temperatureValue": 20.7, "humidityValue": 35, "pressureValue": 103453.62}, 
                        //                            {"timestamp": 35923, "levelValue": 27.9, "temperatureValue": 20.2, "humidityValue": 37, "pressureValue": 103273.25}, 
                        //                            {"timestamp": 36012, "levelValue": 27.5, "temperatureValue": 20.6, "humidityValue": 31, "pressureValue": 103385.64}, 
                        //                        ]
                        //                },
                        //            "S9":
                        //                {
                        //                    "ip":"192.168.0.112", 
                        //                    "record": 
                        //                        [
                        //                            {"timestamp": 35729, "levelValue": 27.3, "temperatureValue": 20.1, "humidityValue": 30, "pressureValue": 103234.45}, 
                        //                            {"timestamp": 35871, "levelValue": 27.1, "temperatureValue": 20.7, "humidityValue": 35, "pressureValue": 103453.62}, 
                        //                            {"timestamp": 35923, "levelValue": 27.9, "temperatureValue": 20.2, "humidityValue": 37, "pressureValue": 103273.25}, 
                        //                            {"timestamp": 36012, "levelValue": 27.5, "temperatureValue": 20.6, "humidityValue": 31, "pressureValue": 103385.64}, 
                        //                        ]
                        //                },
                        //        ]
                        charts = result.data;
                        $.map(charts,function(graph, index){

                            id=index;
                            record=graph.record


                            levelDataList = [];
                            temperatureDataList = [];
                            humidityDataList = [];
                            pressureDataList = [];

                            $.map(record,function(rec){
                                record = {}
                                record.x=new Date(rec.timeStamp*1000);
                                record.y=rec.levelValue;
                                levelDataList.push(record);

                                record = {}
                                record.x=new Date(rec.timeStamp*1000);
                                record.y=rec.temperatureValue;
                                temperatureDataList.push(record);

                                record = {}
                                record.x=new Date(rec.timeStamp*1000);
                                record.y=rec.humidityValue;
                                humidityDataList.push(record);

                                record = {}
                                record.x=new Date(rec.timeStamp*1000);
                                record.y=(rec.pressureValue)/133.322;
                                pressureDataList.push(record);

                            });

                            levelData = {
                                lineTension: 0,
                                label: id,
                                showLine: true,
                                fill: false,
                                borderColor: chartColorList[colorIndex].line,
                                backgroundColor: chartColorList[colorIndex].fill,
                                pointRadius: 2,
                                pointStyle: 'circle',
                                data: levelDataList,
                            };

                            // --- Temperature ---
                            temperatureData = {
                                lineTension: 0,
                                label: id,
                                showLine: true,
                                fill: false,
                                borderColor: chartColorList[colorIndex].line,
                                backgroundColor: chartColorList[colorIndex].fill,
                                pointRadius: 2,
                                pointStyle: 'circle',
                                data: temperatureDataList,
                            };

                            // --- Humidity ---
                            humidityData = {
                                lineTension: 0,
                                label: id,
                                showLine: true,
                                fill: false,
                                borderColor: chartColorList[colorIndex].line,
                                backgroundColor: chartColorList[colorIndex].fill,
                                pointRadius: 2,
                                pointStyle: 'circle',
                                data: humidityDataList,
                            };
                            humidityBeginAtZero = false;
                            humiditySuggestedMin = 20;
                            humiditySuggestedMax = 100;

                            // --- Pressure ---
                            pressureData = {
                                lineTension: 0,
                                label: id,
                                showLine: true,
                                fill: false,
                                borderColor: chartColorList[colorIndex].line,
                                backgroundColor: chartColorList[colorIndex].fill,
                                pointRadius: 2,
                                pointStyle: 'circle',
                                data: pressureDataList,
                            };
                            pressureBeginAtZero = false;
                            pressureSuggestedMin = 750;
                            pressureSuggestedMax = 770;

                            levelChart.data.datasets.push(levelData);

                            temperatureChart.data.datasets.push(temperatureData);

                            humidityChart.data.datasets.push(humidityData);
                            humidityChart.options.scales.y.beginAtZero = humidityBeginAtZero;
                            humidityChart.options.scales.y.suggestedMin = humiditySuggestedMin;
                            humidityChart.options.scales.y.suggestedMax = humiditySuggestedMax;

                            pressureChart.data.datasets.push(pressureData);
                            pressureChart.options.scales.y.beginAtZero = pressureBeginAtZero;
                            pressureChart.options.scales.y.suggestedMin = pressureSuggestedMin;
                            pressureChart.options.scales.y.suggestedMax = pressureSuggestedMax;

                            colorIndex = (colorIndex + 1) % chartColorList.length;

                        });

                        levelChart.update();
                        temperatureChart.update();
                        humidityChart.update();
                        pressureChart.update();

                    }else{
                        //$("#value").html("");
                        $("#errormessage").html("something went wrong");
                        $("#spinner").hide();
                    }

                    $("#errormessage").html("");
                },
                error: function(xhr,status,error){
                    //$("#value").html("");
                    $("#errormessage").html(xhr.statusText + " " + xhr.responseText);
                    $("#spinner").hide();
                }
            });
        }

        // =========================================================================================================================
        //
        // Open Chart Window
        //
        // I pass chart object as parameter to the new window
        //
        // ========================================================================================================================
        function openChartWindow(chart, event, index){
            console.log(chart);

            var url = 'chart.html';
            window.prePopObj = chart;
            var newWindow = window.open('', chart.options.plugins.title.text, '');
            newWindow.location.href = url;
            newWindow.focus();

        }

        // ================================================
        //
        // check pump status
        //
        // ================================================
        function checkPumpStatus(){

            $.get( "/pump/status").done(
                function( data ) {
                    $("#pumpSwitch").off('lcs-on lcs-off');

                    if (data.status == 'off'){
                        lcs_off("#pumpSwitch");
                    }else{
                        lcs_on("#pumpSwitch");

                        // If the pump works, then it triggers the report (in every 5 seconds)
                        $.post( "/sensor/trigger/report" );

                    }
                    $("#pumpSwitch").on('lcs-on', pumpOnEvent);
                    $("#pumpSwitch").on('lcs-off', pumpOffEvent);
            });
        }

        // ================================================
        //
        // check lamp status
        //
        // ================================================
        function checkLampStatus(){
            $.get("/lamp/status").done(
                function( data ) {
                    $("#lampSwitch").off('lcs-on lcs-off');

                    if (data.status == 'off'){
                        lcs_off("#lampSwitch");
                    }else{
                        lcs_on("#lampSwitch");
                    }

                    $("#lampSwitch").on('lcs-on', lampOnEvent);
                    $("#lampSwitch").on('lcs-off', lampOffEvent);
            });
        }

        // ================================================
        //
        // Lamp ON/OFF Event
        //
        // ================================================
        function lampOnEvent(){
            $.post( "/lamp/switch", { "status": "on", "lengthInSec": "10" } );
        }

        function lampOffEvent(){
            $.post( "/lamp/switch", { "status": "off", "lengthInSec": "10" } );
        }

        // ================================================
        //
        // Pump ON/OFF Event
        //
        // ================================================
        function pumpOnEvent(){

            lcs_disable("#pumpSwitch");

            //first check the state of the pump
            $.get( "/pump/status").done(
                function( data ) {

                    //if the pump is OFF
                    if (data.status == 'off'){

                        //the pump can be turn ON
                        $.post( "/pump/turnOn", { "lengthInSec": $( "#slider" ).slider( "value" ) } );
                    }

                    lcs_enable("#pumpSwitch");
                }
            );
        }

        function pumpOffEvent(){

            $.post( "/pump/turnOff" );

        }

        // ================================================
        // ================================================
        //
        //  When the page is loaded
        //
        // ================================================
        // ================================================
        $(document).ready(function(){

            $("#spinner").hide();

            //-----------------------
            // Start Date
            //-----------------------
            $( "#startDatePicker" ).datepicker({
                dateFormat: 'yy-mm-dd',
                changeMonth: true,
                changeYear: true,
                changeHour: true,
            });

            var date = new Date();
            var weekBefore = new Date(date.getFullYear(), date.getMonth(), date.getDate() - 7);
            $('#startDatePicker').datepicker('setDate', weekBefore);

            //-----------------------
            // End Date
            //-----------------------
            $( "#endDatePicker" ).datepicker({
                dateFormat: 'yy-mm-dd',
                changeMonth: true,
                changeYear: true,
                changeHour: true,
            });

            //-----------------------
            // Refresh Chart Button
            //-----------------------
            $("#refreshChartButton").click(function(){
                //startDate = $('#startDatePicker').val();
                //var date = new Date(startDate);
                //startYear = date.getFullYear()
                //startMonth = date.getMonth() + 1
                //startDay = date.getDate()
                //console.log( startYear + "." + startMonth + "." + startDay);

                $("#spinner").show();

                refreshCharts();
            });

            constructCamCaptureSection();

            //-----------------------
            // Lamp Switch
            //-----------------------

            lc_switch("#lampSwitch", {

                on_txt      : 'ON',
                off_txt     : 'OFF',
                on_color    : false,
                compact_mode: false
            });

            lcs_disable("#lampSwitch");

            $.get( "/lamp/status").done(
                function( data ) {
                    if (data.status == 'on'){
                        lcs_on("#lampSwitch")
                        lcs_enable("#lampSwitch");
                    }else{
                        lcs_off("#lampSwitch")
                        lcs_enable("#lampSwitch");
                    }

                    $("#lampSwitch").on('lcs-on', lampOnEvent);
                    $("#lampSwitch").on('lcs-off', lampOffEvent);
                }
            );

            //-----------------------
            // Pump Switch
            //-----------------------

            lc_switch("#pumpSwitch", {

                on_txt      : 'ON',
                off_txt     : 'OFF',
                on_color    : false,
                compact_mode: false
            });

            lcs_disable("#pumpSwitch");

            $.get( "/pump/status").done(
                function( data ) {
                    if (data.status == 'on'){
                        lcs_on("#pumpSwitch")
                        lcs_enable("#pumpSwitch");

                    }else{
                        lcs_off("#pumpSwitch")
                        lcs_enable("#pumpSwitch");
                    }

                    $("#pumpSwitch").on('lcs-on', pumpOnEvent);
                    $("#pumpSwitch").on('lcs-off', pumpOffEvent);
                }
            );

            //-----------------------
            // Tab
            //-----------------------
            $( "#tabs" ).tabs({

                // Initial TAB = Control-Tab
                active: 0

            });

            $(".ui-tabs .ui-tabs-panel").css('padding', '0em');


            //-----------------------
            // Refresh Lamp Status
            //-----------------------
            checkLampStatusRefreshIntervalId = setInterval(checkLampStatus, 5000);

            //-----------------------
            // Refresh Pump Status
            //-----------------------
            checkPumpStatusRefreshIntervalId = setInterval(checkPumpStatus, 5000);


            $( "#tabs" ).tabs({
               activate: function( event, ui ) {

                    // Leave Control-Tab
                    if(ui.oldTab.index() == 0){

                        // No more Check Lamp Status request
//                        clearInterval(checkLampStatusRefreshIntervalId);

                        // No more Check Pump Status request
//                        clearInterval(checkPumpStatusRefreshIntervalId);

                    // Leave Chart-Tab
                    }else if(ui.oldTab.index() == 1){

                        // No more Chart refresh request
                        clearInterval(chartRefreshIntervalId);

                    // Leave Cam-Tab
                    }else if( ui.oldTab.index() == 2){

                        // No more Cam Capture request
                        clearInterval(camCaptureRefreshIntervalId);
                    }

                    //
                    // Select Control-Tab
                    //
                    if(ui.newTab.index() == 0){

                        //-----------------------
                        // Refresh Lamp Status
                        //-----------------------
//                        checkLampStatusRefreshIntervalId = setInterval(checkLampStatus, 5000);

                        //-----------------------
                        // Refresh Lamp Status
                        //-----------------------
//                        checkPumpStatusRefreshIntervalId = setInterval(checkPumpStatus, 5000);

                    // Select Chart-Tab
                    }else if(ui.newTab.index() == 1){

                        //-----------------------
                        // Refresh Charts
                        //-----------------------
                        chartRefreshIntervalId = setInterval(refreshCharts, 600000);

                    // Select Cam-Tab
                    }else if( ui.newTab.index() == 2){

                        //-----------------------
                        // Refresh Cam Capture
                        //-----------------------
                        camCaptureRefreshIntervalId = setInterval(refreshCamCapture, 10000);
                    }
                }
            });

            //-----------------------
            // Slider for Pump
            //-----------------------
            $( "#slider" ).slider({
                value:10,
                min: 10,
                max: 90,
                step: 10,
                slide: function( event, ui ) {
                    $( "#amount" ).text( ui.value + "sec" );
                }
            });
            $( "#amount" ).text( $( "#slider" ).slider( "value" ) + "sec" );


            // control the triggerReport button
            $("#triggerReportButton").on( "click", function() {
                $.post( "/sensor/trigger/report" );
            });

        });

    </script>

</head>

<body style="background-color:DarkGrey;">

    <div class="header" style="position:relative; text-align:center; color:white; text-shadow: 2px 2px 2px green; ">
        <img src="header.jpg" style="width:100%"/>
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); font-weight:bolder; font-size:5vw">Green Wall</div>
    </div>

    <div id="tabs" style="background: none repeat scroll 0% 0% rgb(204, 204, 204);">
        <ul>
            <li><a href="#tabs-control">Control</a></li>
            <li><a href="#tabs-charts">Charts</a></li>
            <li><a href="#tabs-cam">Cam</a></li>
        </ul>

        <!--         -->
        <!-- CONTROL -->
        <!--         -->
        <div id="tabs-control">

            <table id="controller" border="0" class="switchh">
                <tr>
                    <td valign="top" >Lamp:</td>
                    <td >
                        <form>
                            <!-- Sliding Toggle Switch -->
                            <input type="checkbox" name="lampSwitch" value="1" class="lcs_check" id="lampSwitch"/>
                        </form>
                    </td>
                </tr>

                <tr>
                    <td valign="top" >Pump:</td>
                    <td>
                        <form>
                            <!-- Sliding Toggle Switch -->
                            <input type="checkbox" name="pumpSwitch" value="1" class="lcs_check" id="pumpSwitch"/>
                        </form>
                    </td>
                    <td width="10"/>
                    <td valign="top" width="50%">
                        <table width="100%">
                            <tr>
                                <td  id="slider"></td>
                            </tr>
                        </table>
                    </td>
                    <td width="10"/>
                    <td valign="top" id="amount" style="font-weight:bold;"/>
                </tr>


                <tr/>
                <tr/>
                <tr>
                    <td/>
                    <td colspan="4">
                        <a id="triggerReportButton" class="button">
                            <span>Trigger report</span>
                        </a>
                    </td>
                </tr>
                <tr/>
                <tr/>
                <tr/>



            </table>


        </div>



        <!--        -->
        <!-- CHARTS -->
        <!--        -->
        <div id="tabs-charts">

            <table id="dateFilter" border="0">
                <tr>
                    <td> Start date:</td>
                    <td><input type="text" id="startDatePicker" size="8"> </td>
                    <td rowspan="2"><button id="refreshChartButton">Refresh</button></td>
                    <td rowspan="2" width="60px"><img id="spinner" src="spinner.gif" width="60"></td>
                </tr>
                <tr>
                    <td> End date:</td>
                    <td><input type="text" id="endDatePicker" size="8"> </td>
                </tr>
            </table>

            <div id="chartTableDiv" class="flex-chart-container"></div>

            <div id="errormessage"></div>
        </div>

        <!--     -->
        <!-- CAM -->
        <!--     -->
        <div id="tabs-cam">
        </div> 

    </div>

</body>
</html>