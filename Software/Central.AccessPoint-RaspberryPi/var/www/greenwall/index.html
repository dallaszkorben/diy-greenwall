<meta content="text/html;charset=utf-8" http-equiv="Content-Type">

<!--
user-scalable=no -disable user zoom on mobile
-->
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=0.55">

<html>
<head>

    <title>Green Wall</title>

    <style>

        * {
            font-family: "Comic Sans MS", "Comic Sans", cursive;
            font-size: 18px;
        }
    
        h1 {
            font-size: 40px;
        }

        #dateFilter {
            margin-left: auto;
            margin-right: auto;
        }

        #errormessage {
            color: red;
            font-weight: bold;
        }

        #labelstationid {
            white-space: nowrap;
            font-size: 18pt;
            font-weight: bold;
            -moz-transform: rotate(-90deg);
            -moz-transform-origin: center center;
            -webkit-transform: rotate(-90deg);
            -webkit-transform-origin: center center;
            -ms-transform: rotate(-90deg);
            -ms-transform-origin: center center;
            max-width: 2em;
            display: inline-block;
        }

        #refreshChartButton{
            height: 60px;
            vertical-align: top;
        }



    </style>

    <!-- Chart -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.8.0/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/1.30.1/date_fns.js"></script>
    <!-- <script src="http://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <!-- JQuery -->
    <script src="script/jquery/jquery-3.6.0.min.js"></script>
    <script src="script/jquery-ui/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="script/jquery-ui/jquery-ui.css">

    <!-- Switch -->
    <script src="script/switch/lc_switch.js"></script>

    <!-- favicon -->
    <link rel="shortcut icon" href="favicon.ico">

    <script>

        var levelData = [];
        var temperatureData = [];
        var humidityData = [];

        var camCaptureList = [];

        var intervalId = null;

        function isEmpty(str) {
            return (!str || str.length === 0 );
        }

        // =============================
        //
        // Construct Cam Capture Section
        //
        // =============================
        function constructCamCaptureSection(){

            $.ajax({type: "GET", url: "/cam/captureList", async: true,
                success: function(result){

                    res = result.result

                    if(res == "OK"){

                        var tableBody = $("<tbody>");

                        $.map(result.camCaptureList, function(camCapture){

                            camId = camCapture.camId;
                            camCaptureUrl = camCapture.captureUrl;

                            cc = {};
                            cc['camId'] = camId;
                            cc['camCaptureUrl'] = camCaptureUrl;
                            camCaptureList.push(cc);
    
                            row = $("<tr>");
                            rowData = $("<td>");

                            var img = $('<img id="cam_' + camId + '">');
                            // Random value after the image name helps to ignore the cache at refresh
                            img.attr('src', '/greenwall/cam-capture/capture_' + camId + '.jpg?' + Math.random());
                            img.attr('width', '400px');
                            img.attr('style', '')
                            rowData.html(img);
                            row.append(rowData);

                            tableBody.append(row);

                        });

                        var table = $('<table border="0"></table>').append(tableBody);

                        $('#camCaptureDiv').html("");
                        $('#camCaptureDiv').append(table);


                    }else{
                        //$("#value").html("");
                        //$("#errormessage").html("something went wrong");
                        //$("#spinner").hide();
                    }

//                    $("#errormessage").html("");
                },
                error: function(xhr,status,error){
//                    $("#value").html("");
//                    $("#errormessage").html(xhr.statusText + " " + xhr.responseText);
//                    $("#spinner").hide();
                }
            });
        }

        // ================================================
        //
        // Refresh Cam Capture
        //
        // ================================================
        function refreshCamCapture(){

            $.map(camCaptureList, function(camCapture){

                camId = camCapture.camId;
                camCaptureUrl = camCapture.captureUrl;

                $.ajax({type: "GET", url: "/cam/capture/url/camId/" + camId, async: true,
                    success: function(result){

                        res = result.result

                        if(res == "OK"){

                            // Random value after the image name helps to ignore the cache at refresh
                            $("#cam_" + camId).attr('src', '/greenwall/cam-capture/capture_' + camId + '.jpg?' + Math.random());

                        }else{
                            console.log("ERROR:" + error);
                        }
                    },
                    error: function(xhr,status,error){
                        console.log("ERROR:" + error);
                    }
                });
            });


        }

        // ================================================
        //
        // Construct a Chart Canvas
        //
        // ================================================
        function constructChartCanvas(chartCanvasId, title, labelY){
            var myChart = new Chart(document.getElementById(chartCanvasId), {
                type: 'scatter',
                data: {
                    datasets: [
                    ]
                },
                options: {
                    aspectRatio:1.5,
                    plugins:{
                        title: {
                            display: true,
                            text: title
                        },
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true
                            }
                        },
                    },
                    responsive: true,
                    scales: {
                        x: {
                            grid: {
                                borderWidth: 2,
                                borderColor: '#000000',
                            },

                            type: 'time',
                            //distribution: 'series',
                            time: {
                                //unitStepSize: 10,
                                //parser: 'yy.MM.dd',
                                unit: 'day',
                                tooltipFormat: 'yyyy.MM.dd HH:mmzzz',
                                displayFormats: {
                                    'hour': 'HH:mmzzz',
                                    'day': 'yyyy.MM.dd',
                                    'week': 'yyyy.MM.dd',
                                    'month': 'yyyy.MM',
                                    'quarter': 'yyyy.MM',
                                    'year': 'yyyy',
                                },
                            },
                            title: {
                                display: false,
                                text: 'Date',
                            },
                            ticks: {

                                // Bold on Sunday
                                font:{
                                    weight: (c) => {
                                        day = new Date(c.tick.value).getDay()
                                        return day == 0 ? 'bold' : 'normal';
                                    }
                                },

                                display: true,
                                minRotation: 20,
                                align: 'center',

                                    //major: {
                                    //   font: 'bold',
                                    //   enabled: false,
                                    //   unit: 'day',
                                    //   fontColor: 'red',
                                    //   unitStepSize: 2,
                                    //   displayFormats: {
                                    //      'day': 'yyyy.MM.dd',
                                    //      'hour': 'yyyy'
                                    //   },
                                    //},

                                // Red color on Sunday
                                color: (c) => {
                                    day = new Date(c.tick.value).getDay()
                                    return day == 0 ? 'red' : 'black';
                                }

                                //callback: function(value, index, ticks) {
                                //   ticks.forEach(t => {
                                //      const day = new Date(t.value).getDay();
                                //      t.major = (day == 0 || day == 6);
                                //   });
                                //   return '$' + value;
                                //}

                            },
                        },
                        y: {
                            grid: {
                                borderWidth: 2,
                                borderColor: '#000000',
                                display: true,
                            },

                            beginAtZero: true,
                            display: true,
                            ticks: {
                                display: true,
                                //stepSize: 10,
                            },
                            title: {
                                display: true,
                                text: labelY
                            },
                        }
                    },
                }
            });
            return myChart;
        }

        // ================================================
        //
        // Refresh Charts
        //
        // ================================================
        function refreshCharts(){

            $("#spinner").show();

            // Fetch the date values from the fields
            startDate = $('#startDatePicker').val();
            endDate = $('#endDatePicker').val();

            if (!isEmpty(endDate)){
                // Add 1 more day construct midnight of endDate
                var date = new Date(endDate);
                date.setDate(date.getDate() + 1)

                endYear = date.getFullYear()
                endMonth = date.getMonth() + 1
                endDay = date.getDate()
            }

            param = "startDate/" + startDate + ( isEmpty(endDate) ? "" : ("/endDate/" + endYear + "-" + endMonth + "-" + endDay))

            $("#errormessage").html("");

            $.ajax({type: "GET", url: "/sensor/data/list/" + param, async: true,
                success: function(result){

                    $("#spinner").hide();

                    res = result.result

                    if(res == "OK"){

                        //
                        // header line
                        //
                        row = $("<tr>");

                        // Water level
                        rowData = $("<th width='33%'>");
                        rowData.html("Water level [mm]")
                        row.append(rowData)

                        // t=Temperature
                        rowData = $("<th width='33%'>");
                        rowData.html("Temperature [°C]")
                        row.append(rowData)

                        // Humidity
                        rowData = $("<th width='33%'>");
                        rowData.html("Humidity [%]")
                        row.append(rowData)

                        var tableBody = $("<tbody>");
                        tableBody.append(row)

                        //
                        // === construct the canvases === //
                        //

                        row = $('<tr>');

                        var levelCanvasId = "levelCanvas";
                        var temperatureCanvasId = "temperatureCanvas";
                        var humidityCanvasId = "humidityCanvas";

                        // Level
                        rowData = $('<td style="padding:1px">');
                        //rowData = rowData.html('<canvas id="' + levelCanvasId + '" style="width:700px;max-width:700px;background-color: #98fb98;"></canvas>');
                        rowData = rowData.html('<canvas id="' + levelCanvasId + '" style="width:33%;background-color: #98fb98;"></canvas>');
                        row.append(rowData);

                        // Temperature
                        rowData = $('<td style="padding:1px">');
                        //rowData = rowData.html('<canvas id="' + temperatureCanvasId + '" style="width:700px;max-width:700px;background-color: #98fb98;"></canvas>');
                        rowData = rowData.html('<canvas id="' + temperatureCanvasId + '" style="width:33%;background-color: #98fb98;"></canvas>');
                        row.append(rowData);

                        // Humidity
                        rowData = $('<td style="padding:1px">');
                        //rowData = rowData.html('<canvas id="' + humidityCanvasId + '" style="width:700px;max-width:700px;background-color: #98fb98;"></canvas>');
                        rowData = rowData.html('<canvas id="' + humidityCanvasId + '" style="width:33%;background-color: #98fb98;"></canvas>');
                        row.append(rowData);

                        tableBody.append(row);

                        var table = $('<table border="0" width="100%"></table>').append(tableBody);

                        // Clear the chartTableDiv
                        $('#chartTableDiv').html("");

                        // Build up new Charts
                        $('#chartTableDiv').append(table);

                        levelChart=constructChartCanvas(levelCanvasId, "Water Level", "Level [mm]");
                        temperatureChart=constructChartCanvas(temperatureCanvasId, "Temperature", "Temperature [C°]");
                        humidityChart=constructChartCanvas(humidityCanvasId, "Humidity", "Humidity [%]");

                        //
                        // === fill up the data lists for charts === //
                        //

                        var chartColorList = [
                            {line: "#0000FF", fill: "rgba(0,0,255, 0.5)" },
                            {line: "#f542ef", fill: "rgba(245, 66, 239, 0.5)" },
                            {line: "#f59c42", fill: "rgba(246, 156, 66, 0.5)" },
                            {line: "#dd42f5", fill: "rgba(221,66,245, 0.5)" },
                            {line: "#42dbf6", fill: "rgba(66, 219, 246, 0.5)" },
                        ]

                        colorIndex=0;
                        charts = result.data;
                        $.map(charts,function(graph, index){
    
                            id=index;
                            record=graph.record

                            levelDataList = [];
                            temperatureDataList = [];
                            humidityDataList = [];

                            $.map(record,function(rec){
                                record = {}
                                record.x=new Date(rec.timeStamp*1000);
                                record.y=rec.levelValue;
                                levelDataList.push(record);

                                record = {}
                                record.x=new Date(rec.timeStamp*1000);
                                record.y=rec.temperatureValue;
                                temperatureDataList.push(record);

                                record = {}
                                record.x=new Date(rec.timeStamp*1000);
                                record.y=rec.humidityValue;
                                humidityDataList.push(record);

                            });

                            levelData = {
                                lineTension: 0,
                                label: id,
                                showLine: true,
                                fill: false,
                                borderColor: chartColorList[colorIndex].line,
                                backgroundColor: chartColorList[colorIndex].fill,
                                pointRadius: 2,
                                pointStyle: 'circle',
                                data: levelDataList,
                            };

                            temperatureData = {
                                lineTension: 0,
                                label: id,
                                showLine: true,
                                fill: false,
                                borderColor: chartColorList[colorIndex].line,
                                backgroundColor: chartColorList[colorIndex].fill,
                                pointRadius: 2,
                                pointStyle: 'circle',
                                data: temperatureDataList,
                            };

                            humidityData = {
                                lineTension: 0,
                                label: id,
                                showLine: true,
                                fill: false,
                                borderColor: chartColorList[colorIndex].line,
                                backgroundColor: chartColorList[colorIndex].fill,
                                pointRadius: 2,
                                pointStyle: 'circle',
                                data: humidityDataList,
                            };

                            levelChart.data.datasets.push(levelData);
                            temperatureChart.data.datasets.push(temperatureData);
                            humidityChart.data.datasets.push(humidityData);

                            colorIndex = (colorIndex + 1) % chartColorList.length;

                        });

                        levelChart.update();
                        temperatureChart.update();
                        humidityChart.update();

                    }else{
                        //$("#value").html("");
                        $("#errormessage").html("something went wrong");
                        $("#spinner").hide();
                    }

                    $("#errormessage").html("");
                },
                error: function(xhr,status,error){
                    //$("#value").html("");
                    $("#errormessage").html(xhr.statusText + " " + xhr.responseText);
                    $("#spinner").hide();
                }
            });
        }



        // ================================================
        //
        // check pump status
        //
        // ================================================
        function checkPumpStatus(){

            $.get( "/pump/status").done(
                function( data ) {

                    if (data.status == 'off'){
                        lcs_off("#pumpSwitch");
                    }            
            });
        }

        // ================================================
        // ================================================
        //
        //  When the page is loaded
        //
        // ================================================
        // ================================================
        $(document).ready(function(){

            $("#spinner").hide();

            //-----------------------
            // Start Date
            //-----------------------
            $( "#startDatePicker" ).datepicker({
                dateFormat: 'yy-mm-dd',
                changeMonth: true,
                changeYear: true,
                changeHour: true,
            });

            var date = new Date();
            var weekBefore = new Date(date.getFullYear(), date.getMonth(), date.getDate() - 7);
            $('#startDatePicker').datepicker('setDate', weekBefore);

            //-----------------------
            // End Date
            //-----------------------
            $( "#endDatePicker" ).datepicker({
                dateFormat: 'yy-mm-dd',
                changeMonth: true,
                changeYear: true,
                changeHour: true,
            });

            //-----------------------
            // Refresh Chart Button
            //-----------------------
            $("#refreshChartButton").click(function(){
                //startDate = $('#startDatePicker').val();
                //var date = new Date(startDate);
                //startYear = date.getFullYear()
                //startMonth = date.getMonth() + 1
                //startDay = date.getDate()
                //console.log( startYear + "." + startMonth + "." + startDay);

                $("#spinner").show();

                refreshCharts();
            });

            constructCamCaptureSection();

            //-----------------------
            // Refresh Charts
            //-----------------------
            setInterval(refreshCharts, 600000);

            //-----------------------
            // Refresh Cam Capture
            //-----------------------
            setInterval(refreshCamCapture, 2000);


            //-----------------------
            // Lamp Switch
            //-----------------------

            lc_switch("#lampSwitch", {

                on_txt      : 'ON',
                off_txt     : 'OFF',
                on_color    : false,
                compact_mode: false
            });

            lcs_disable("#lampSwitch");

            $.get( "/lamp/status").done(
                function( data ) {
                    if (data.status == 'on'){
                        lcs_on("#lampSwitch")
                        lcs_enable("#lampSwitch");
                    }else{
                        lcs_off("#lampSwitch")
                        lcs_enable("#lampSwitch");
                    }

                    $("#lampSwitch")[0].addEventListener('lcs-on', function(){
                        $.post( "/lamp/switch", { "status": "on", "lengthInSec": "10" } );
                    });

                    $("#lampSwitch")[0].addEventListener('lcs-off', function(){
                        $.post( "/lamp/switch", { "status": "off", "lengthInSec": "10" } );
                    });
            });

            //-----------------------
            // Pump Switch
            //-----------------------

            lc_switch("#pumpSwitch", {

                on_txt      : 'ON',
                off_txt     : 'OFF',
                on_color    : false,
                compact_mode: false
            });

            lcs_disable("#pumpSwitch");

            $.get( "/pump/status").done(
                function( data ) {
                    if (data.status == 'on'){
                        lcs_on("#pumpSwitch")
                        lcs_enable("#pumpSwitch");

                        // 5 sec
                        intervalId = setInterval(checkPumpStatus, 5000);
                        //console.log("initial intervalId: " + intervalId);

                    }else{
                        lcs_off("#pumpSwitch")
                        lcs_enable("#pumpSwitch");
                    }

                    $("#pumpSwitch")[0].addEventListener('lcs-on', function(){

                        lcs_disable("#pumpSwitch");

                        //first check the state of the pump

                        $.get( "/pump/status").done(
                            function( data ) {

                                //if the pump is OFF
                                if (data.status == 'off'){

                                    //the the pump can be turn ON
                                    $.post( "/pump/turnOn", { "lengthInSec": "30" } );
                                }
                                intervalId = setInterval(checkPumpStatus, 5000);

                                //console.log("intervalId: " + intervalId);

                                lcs_enable("#pumpSwitch");
                            }
                        );
                    });

                    $("#pumpSwitch")[0].addEventListener('lcs-off', function(){
                        $.post( "/pump/turnOff" );
                        clearInterval(intervalId);

                        //console.log("end of interval check. intervalid: " +  intervalId);
                        //console.log(" ");
                    });
            });
        });

    </script>

</head>

<body style="background-color:DarkGrey;">
    <center><h1>Green Wall</h1></center> 

    <hr> <!-- ------------------------ -->

    <table id="controller" border="0" class="switchh">
        <tr>
            <td valign="top" >Lamp:</td>
            <td >
                <form>
                   <input type="checkbox" name="lampSwitch" value="1" class="lcs_check" id="lampSwitch"/>
                </form>
            </td>
        </tr>

        <tr>
            <td valign="top" >Pump:</td>
            <td >
                <form>
                   <input type="checkbox" name="pumpSwitch" value="1" class="lcs_check" id="pumpSwitch"/>
                </form>
            </td>
        </tr>

    </table>

    <hr> <!-- ------------------------ -->

    <table id="dateFilter" border="0">
        <tr>
            <td> Start date:</td>
            <td><input type="text" id="startDatePicker" size="8"> </td>
            <td rowspan="2"><button id="refreshChartButton">Refresh</button></td>
            <td rowspan="2" width="60px"><img id="spinner" src="spinner.gif" width="60"></td> 
        </tr>
        <tr>
            <td> End date:</td>
            <td><input type="text" id="endDatePicker" size="8"> </td>
        </tr>
    </table>


    <div id="chartTableDiv"></div>
    <div id="errormessage"></div>

    <hr> <!-- ------------------------ -->

    <div id="camCaptureDiv"></div>


</body>
</html>