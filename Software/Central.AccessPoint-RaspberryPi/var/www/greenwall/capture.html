<meta comntent="text/html;charset=utf-8" http-equiv="Content-Type">

<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=0.55">

<html>
    <head>

    <title>Cam</title>

    <!-- favicon -->
    <link rel="shortcut icon" href="favicon.ico">

    <!-- JQuery -->
    <script src="script/jquery/jquery-3.6.0.min.js"></script>
    <script src="script/jquery-ui/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="script/jquery-ui/jquery-ui.css">

    <!-- Switch -->
    <script src="script/switch/lc_switch.js"></script>

    <!-- Touch-Punch - needed for jQuery-slider on android -->
    <script src="script/touch-punch/jquery.ui.touch-punch.min.js"></script>

    <style>
<!--        .ui-slider-tick-mark{
            display:inline-block;
            width:1px;
            background:black;
            height:12px;
            position:absolute;
            top:16px;
        }

        #progressbar .ui-progressbar-value {
            background-color: #ccc;
        }
-->
    </style>

    <script>

        var camId;
        var refreshCaptureIntervalId = null;
        var fileList = [];
        var currentFileIndex = null;

        var forwardButtonDown = false;
        var backwardButtonDown = false;

        var slideFramesIntervalId = null;

        $(document).ready(function(){

            // I get the camId parameter as the window.name - window.open()

            //
            // Fetch camId
            //
            camId = window.name;

            //
            // Title of new window
            //
            $(document).find("title").html(camId);

            //
            // Write camId
            //
            $(document).find("#title").html(camId);

            //
            // Create <img> node
            //
            var img = $('<img id="cam_' + camId + '">');

            // Random value after the image name helps to ignore the cache at refresh
            img.attr('src', '/greenwall/cam-capture/capture_' + camId + '.jpg?' + Math.random());

            // Add <img> node
            $(document).find("#img").append(img);

/*            // History slider
            $( "#historySlider" ).slider({
                min: -10,
                max: 10,
                step: 1,
                value: 0,
                animate: 'true',
                animate: 100,
                create: function( event, ui ) {
                    setSliderTicks(event.target);
                },

            });
            $("#historySlider").on('slidechange', slideChangeEvent);
*/

            // Live/History switch
            lc_switch("#liveSwitch", {

                on_txt      : 'Live',
                off_txt     : 'History',
                on_color    : false,
                compact_mode: false
            });

            $("#liveSwitch").on('lcs-on', liveOnEvent);
            $("#liveSwitch").on('lcs-off', liveOffEvent);

            lcs_enable("#liveSwitch");
            lcs_on("#liveSwitch");

            // Progerss bar
            $( "#progressbar" ).progressbar({
              value: false
            });

            // Button Forward
            $("#buttonForward").on( "mousedown", buttonForwardStartEvent );
            $("#buttonForward").on( "mouseup", buttonForwardStopEvent );
            $("#buttonForward").on( "mouseleave", buttonForwardStopEvent );
            $("#buttonForward").hide();

            // Button Backward
            $("#buttonBackward").on( "mousedown", buttonBackwardStartEvent );
            $("#buttonBackward").on( "mouseup", buttonBackwardStopEvent );
            $("#buttonBackward").on( "mouseleave", buttonBackwardStopEvent );
            $("#buttonBackward").hide();

        });

        function buttonForwardStartEvent(){
            forwardButtonDown = true;
            console.log("forward START");
//            selectNextImage(1);
            slideFramesIntervalId = setInterval(slideFramesForward, 100);
        }

        function buttonBackwardStartEvent(){
            backwardButtonDown = true;
            console.log("backward START");
//            selectNextImage(-1);
            slideFramesIntervalId = setInterval(slideFramesBackward, 100);
        }

        function buttonForwardStopEvent(){
            if (forwardButtonDown){
                forwardButtonDown = false;
                console.log("forward STOP");
                clearInterval(slideFramesIntervalId);
            }
        }

        function buttonBackwardStopEvent(){
            if (backwardButtonDown){
                backwardButtonDown = false;
                console.log("backward STOP");
                clearInterval(slideFramesIntervalId);
            }
        }

        function slideFramesForward(){
            slideFrames(1);
        }

        function slideFramesBackward(){
            slideFrames(-1);
        }

        function slideFrames(delta){
console.log("INTERVAL");
            if( delta < 0 ){

                currentFileIndex = Math.max(0, currentFileIndex + delta);
            }else if( delta > 0 ){

                currentFileIndex = Math.min(fileList.length - 1, currentFileIndex + delta);
            }
            fileName = fileList[currentFileIndex];
            $("#cam_" + camId).attr('src', 'cam-frame/' + camId + '/' + fileName);
        }

        // ================================================
        //
        // Refresh Capture
        //
        // ================================================
        function refreshCapture(){

            // Random value after the image name helps to ignore the cache at refresh
            $("#cam_" + camId).attr('src', '/greenwall/cam-capture/capture_' + camId + '.jpg?' + Math.random());
        }

        // ================================================
        //
        // Set Slider Ticks
        //
        // ================================================
/*        function setSliderTicks(el) {
            var $slider =  $(el);
            var max =  $slider.slider("option", "max");
            var min =  $slider.slider("option", "min");
            var spacing =  100 / (max - min);

            $slider.find('.ui-slider-tick-mark').remove();
            for (var i = 0; i < max-min ; i++) {
                $('<span class="ui-slider-tick-mark"></span>').css('left', (spacing * i) +  '%').appendTo($slider); 
             }
        }
*/

        // ================================================
        //
        // Slider Change Event
        //
        // Turns off the event listener
        // Moves back the slider to zero
        // Turn on back the event listener
        // Depending on the slider value, fetches the corresponding file name
        //
        // ================================================
/*        function slideChangeEvent(event, ui){
            $("#historySlider").off('slidechange');
            $("#historySlider").slider( "option", "value", 0 );
            $("#historySlider").on('slidechange', slideChangeEvent);

            if( ui.value < 0 ){

                currentFileIndex = Math.max(0, currentFileIndex + ui.value);
            }else if( ui.value > 0 ){

                currentFileIndex = Math.min(fileList.length - 1, currentFileIndex + ui.value);
            }
            fileName = fileList[currentFileIndex];
            $("#cam_" + camId).attr('src', 'cam-frame/' + camId + '/' + fileName);

        }
*/
        // ================================================
        //
        // Live button ON Event
        //
        // ================================================
        function liveOnEvent(){
//            $("#historySlider").hide();
            $("#buttonForward").hide();
            $("#buttonBackward").hide();
            refreshCapture();
            refreshCaptureIntervalId = setInterval(refreshCapture, 10000);
            $( "#progressbar" ).hide();
        }

        // ================================================
        //
        // Live button OFF Event
        //
        // ================================================
        function liveOffEvent(){
            clearInterval(refreshCaptureIntervalId);

            $( "#progressbar" ).show();

            $.ajax({type: "GET", url: "/cam/frame/files/camId/" + camId, 
                    async: true,
                    data: {},
                    indexValue: {camId:camId}, 
                    success: function(data){

                        if(data.result == "OK"){

                            fileList = data.fileList;
                            currentFileIndex = fileList.length - 1;

                            $( "#progressbar" ).hide();
                            $("#buttonForward").show();
                            $("#buttonBackward").show();

//                            $("#historySlider").show();

                        }else{
                            console.error("Get Frame File List ERROR:" + error);
                        }
                    },
                    error: function(xhr,status,error){
                        console.error("Get Frame File List ERROR:" + error);
                    }
            });
        }

    </script>

    </head>

    <body>
        <table border="0">

            <tr>
                <td> </td>
                <td id="title" style="text-align:center; font-size:1.5em; font-weight: bold;">
                    camId
                </td>
                <td> </td>
            </tr>
            <tr>
                <td> </td>
                <td>
                    <form>
                        <!-- Sliding Toggle Switch -->
                        <input type="checkbox" name="liveSwitch" value="1" class="lcs_check" id="liveSwitch"/>
                    </form>
                </td>
                <td> </td>
            </tr>

<!--            <tr>
                <td> </td>
                <td height="30px">
                    <div id="historySlider"></div>
                </td>
                <td> </td>
            </tr>
-->
            <tr>
                <td> </td>
                <td height="40px">
                    <div id="progressbar"></div>
                </td>
                <td> </td>
            </tr>

            <tr>
                <td width="60px">
                    <button id="buttonBackward" class="ui-button ui-widget ui-corner-all">
                        &#8592;
                    </button>
                </td>
                <td id='img'>
                <!-- <img id="cam_' + camId + '" src="/greenwall/cam-capture/capture_' + camId + '.jpg?"> -->
                </td>
                <td width="60px">
                    <button id="buttonForward" class="ui-button ui-widget ui-corner-all">
                        &#8594;
                    </button>
                </td>
            </tr>
        </table>
    </body>
</html>
