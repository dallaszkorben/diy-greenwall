<meta content="text/html;charset=utf-8" http-equiv="Content-Type">

<!--
user-scalable=no	-disable user zoom on mobile
-->
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=0.55">

<html>
<head>

    <title>Green Wall</title>

<style>

    #errormessage {
        color: red;
        font-weight: bold;
    }

    #labelstationid {
        white-space: nowrap;
        font-family: Verdana;
        font-size: 18pt;
        font-weight: bold;
        -moz-transform: rotate(-90deg);
        -moz-transform-origin: center center;
        -webkit-transform: rotate(-90deg);
        -webkit-transform-origin: center center;
        -ms-transform: rotate(-90deg);
        -ms-transform-origin: center center;
        max-width: 4em;
        display: inline-block;
    }

    aaspan {
        text-align:center;
        max-width: 3em;
        display: inline-block;
        white-space:nowrap;
    }
</style>

<script src="script/jquery/jquery-3.6.0.min.js"></script>
<script src="script/jquery-ui/jquery-ui.min.js"></script>
<link rel="stylesheet" href="script/jquery-ui/jquery-ui.css">

<script>

    function isEmpty(str) {
        return (!str || str.length === 0 );
    }

    // ================================================
    //
    // refresh the graphs
    //
    // ================================================
    function refreshGraphs(){

        startDate = $('#startDatePicker').val();
        endDate = $('#endDatePicker').val();

        if (!isEmpty(endDate)){
            // Add 1 more day construct midnight of endDate
            var date = new Date(endDate);
            date.setDate(date.getDate() + 1)

            endYear = date.getFullYear()
            endMonth = date.getMonth() + 1
            endDay = date.getDate()
            console.log( endYear + "." + endMonth + "." + endDay);
        }

        param = "startDate/" + startDate + ( isEmpty(endDate) ? "" : ("/endDate/" + endYear + "-" + endMonth + "-" + endDay))

        $.ajax({type: "GET", url: "http://192.168.0.104:5000/info/graph/" + param, async: true,
            success: function(result){

                res = result.result

                if(res == "OK"){

                    var table = $('<table border="0"></table>');

                    //
                    // header line
                    //
                    row = $("<tr>");

                    // empty
                    rowData = $('<th>');
                    row.append(rowData)

                    // water level
                    rowData = $("<th>");
                    rowData.html("Water level")
                    row.append(rowData)

                    // temperature
                    rowData = $("<th>");
                    rowData.html("Temperature [Â°C]")
                    row.append(rowData)

                    // humidity
                    rowData = $("<th>");
                    rowData.html("Humidity [%]")
                    row.append(rowData)

                    var tableBody = $("<tbody>");
                    tableBody.append(row)

                    graphs = result.graphs;
                    $.map(graphs,function(graph){
                        stationId = graph.stationId;
                        levelPath = graph.levelPath;
                        temperaturePath = graph.temperaturePath;
                        humidityPath = graph.humidityPath;

                        row = $('<tr>');

                        // StationId
                        rowData = $('<td>');
//                        stationIdField = $('<dev id="labelstationid"></dev>').append($('<span>')).append('Sensor ').append(stationId);
                        stationIdField = $('<dev id="labelstationid">').html('Sensor ' + stationId);
                        rowData.html(stationIdField);

                        row.append(rowData);

                        // Level
                        rowData = $('<td style="padding:1px">');
                        if(levelPath != null){
                            // Tricky solution to clean the image cache
                            rowData = rowData.html('<img src="' + levelPath + '?v=' + (new Date()).getTime() + '" alt="can not find image">');
                        }
                        row.append(rowData);

                        // Temperature
                        rowData = $('<td style="padding:1px">');
                        if(temperaturePath != null){
                            // Tricky solution to clean the image cache
                            rowData = rowData.html('<img src="' + temperaturePath + '?v=' + (new Date()).getTime() + '" alt="can not find image">');
                        }
                        row.append(rowData);

                        // Humidity
                        rowData = $('<td style="padding:1px">');
                        if(humidityPath != null){
                            // Tricky solution to clean the image cache
                            rowData = rowData.html('<img src="' + humidityPath + '?v=' + (new Date()).getTime() + '" alt="can not find image">');
                        }
                        row.append(rowData);

                        tableBody.append(row);
                    });

                    $('#graphTableDiv').html("");
                    $('#graphTableDiv').append(tableBody);

                }else{
                    $("#value").html("");
                    $("#errormessage").html("something went wrong");
                }

                $("#errormessage").html("");
            },
            error: function(xhr,status,error){
                $("#value").html("");
                $("#errormessage").html(xhr.statusText + " " + xhr.responseText);
            }
        });
    }

    // ================================================
    //  When the page is loaded
    // ================================================
    $(document).ready(function(){

        //-----------------------
        // Start Date
        //-----------------------
        $( "#startDatePicker" ).datepicker({
            dateFormat: 'yy-mm-dd',
            changeMonth: true,
            changeYear: true,
            changeHour: true,

//            onSelect: function(datetext){
//                console.log(datetext)
//            }
        });

        var date = new Date();
        var weekBefore = new Date(date.getFullYear(), date.getMonth(), date.getDate() - 7);
        $('#startDatePicker').datepicker('setDate', weekBefore);

        //-----------------------
        // End Date
        //-----------------------
        $( "#endDatePicker" ).datepicker({
            dateFormat: 'yy-mm-dd',
            changeMonth: true,
            changeYear: true,
            changeHour: true,
        });

        //-----------------------
        // Refresh graph Button
        //-----------------------
        $("#refreshGraphButton").click(function(){
//            startDate = $('#startDatePicker').val();
//            var date = new Date(startDate);
//            startYear = date.getFullYear()
//            startMonth = date.getMonth() + 1
//            startDay = date.getDate()
//            console.log( startYear + "." + startMonth + "." + startDay);
            refreshGraphs();
        });






        //-----------------------
        // Refresh graphs
        //-----------------------
        //refreshGraphs();
        setInterval(refreshGraphs, 600000);
    });
</script>
</head>
<body style="background-color:DarkGrey;">
    <center><h1>Green Wall</h1></center> 

    <table border="1">
        <tr>
            <td> Start date:</td>
            <td><input type="text" id="startDatePicker"> </td>
            <td colspane="2"><button id="refreshGraphButton">Refresh</button></td>
        </tr>
        <tr>
            <td> End date:</td>
            <td><input type="text" id="endDatePicker"> </td>
        </tr>


    </table>

    <div id="graphTableDiv"></div>

    <div id="value"></div>

    <div id="errormessage"></div>

</body>
</html>